<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Steampunk Menu</title>
  <link rel="stylesheet" href="css/steampunk-cards.css">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/img/icon-192.svg" type="image/svg+xml">
  <style>
    /* Коллекція: грид карт */
    .collection-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 8px;
      margin-top: 8px;
    }
    .collection-card-item {
      background: rgba(50,30,20,0.4);
      border: 1.5px solid rgba(242,208,122,0.15);
      border-radius: 8px;
      padding: 10px 6px;
      text-align: center;
      transition: all 0.2s;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .collection-card-item.found {
      background: linear-gradient(180deg, rgba(242,208,122,0.12), rgba(0,0,0,0.18));
      border-color: #8bc34a;
      color: var(--brass-0);
    }
    .collection-card-item.not-found {
      background: linear-gradient(180deg, #222 60%, #111 100%);
      border-color: #444;
      color: #888;
      opacity: 0.6;
    }
    .collection-card-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .collection-card-status {
      font-size: 11px;
      color: #8bc34a;
    }
    .collection-card-item.not-found .collection-card-status {
      color: #aaa;
    }
    /* Сетка слабших карт — по 3 в ряд */
    .weaker-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    .weaker-card-tile {
      background: rgba(30,20,18,0.45);
      border: 1px solid rgba(200,170,120,0.08);
      padding: 6px;
      border-radius: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    /* Ensure the visual inside weaker-card tiles matches deck card sizing */
    .weaker-card-visual{
      display: block;
      width: 100%;
      flex: 1 1 auto;
      align-items: center;
      justify-content: center;
      display: flex;
    }
    .weaker-card-visual .sp-card{
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      padding: 4px !important;
      aspect-ratio: 0.6 / 1 !important;
      margin: 0 auto !important;
    }
    .weaker-card-footer { display:flex; justify-content:space-between; align-items:center; gap:6px; margin-top:8px; }
    .weaker-card-pct { color: #c6ffb3; font-weight:700; }
    .weaker-add-btn { background:#c85; border:none; color:#111; padding:6px 8px; border-radius:6px; cursor:pointer }
    :root{
      --bg-0:#080605;
      --bg-1:#120d0a;
      --wood:#1a120c;

      --brass-0:#f2d07a;
      --brass-1:#c59b3c;
      --brass-2:#7a5520;

      --copper-0:#d8905b;
      --copper-1:#b56a33;
      --copper-2:#6f3316;

      --steel-0:#2a2f33;
      --steel-1:#14181b;

      --ink:#f4e6c6;
      --muted:#d0bf9a;

      --glow: rgba(255, 210, 110, 0.22);
      --shadow: rgba(0,0,0,0.65);

      --radius: 14px;

      /* Стихії */
      --fire:#c45a2a;
      --water:#3b6c8e;
      --air:#9fb6c1;
      --earth:#7a6a3a;
      --steam:#8a7f8a;
      --mech:#5a5a5a;
      
      /* Рідкості */
      --common:#b8a27b;
      --rare:#6fb2ff;
      --epic:#b07cff;
      --legend:#ffcc66;
      --tile-radius: 18px;
    }

    /* Base */
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Georgia, "Times New Roman", serif;
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(255,200,120,0.10), transparent 55%),
        radial-gradient(900px 700px at 20% 25%, rgba(212,140,75,0.10), transparent 50%),
        radial-gradient(1000px 900px at 80% 60%, rgba(120,70,40,0.10), transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-0));
      min-height: 100dvh;
      display:block;
    }

    /* Phone frame */
    .phone{
      width:100vw;
      min-height:100dvh;
      padding: 0;
      position: relative;
      background: transparent;
      overflow:hidden;
      display: flex;
      flex-direction: column;
    }

    /* Side copper rails */
    .phone::before,
    .phone::after{
      content:"";
      position:absolute;
      top:-30px; bottom:-30px;
      width: 18px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.10), transparent 12%),
        linear-gradient(180deg, #3b2010, #7a3b1a 35%, #a55a2b 50%, #6a2d12 70%, #2b140a);
      box-shadow: inset 0 0 0 1px rgba(255,210,120,0.25), 0 0 18px rgba(0,0,0,0.5);
      filter: saturate(1.1);
      opacity:0.95;
      border-radius: 12px;
    }
    .phone::before{ left:-6px; }
    .phone::after { right:-6px; }

    /* Subtle noise overlay */
    .noise{
      pointer-events:none;
      position:absolute; inset:0;
      opacity:0.10;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.08) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,0.07) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,0.06) 0 1px, transparent 2px);
      background-size: 60px 60px, 80px 80px, 100px 100px;
      mix-blend-mode: overlay;
    }

    /* Top bar */
    .topbar{
      position: relative;
      padding: 10px 10px 12px;
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, rgba(255,210,110,0.08), rgba(0,0,0,0.35)),
        linear-gradient(180deg, #1b120c, #0c0907);
      box-shadow: 0 10px 24px var(--shadow);
      border: 1px solid rgba(245,210,120,0.20);
    }
    .topbar::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(242,208,122,0.35), rgba(213,143,85,0.18), rgba(90,50,20,0.10));
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      padding: 1px;
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }

    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .avatar{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }

    .portrait{
      width:36px; height:36px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,230,170,0.18), transparent 55%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.35);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6), 0 6px 12px rgba(0,0,0,0.55);
      position: relative;
    }
    .portrait::after{
      content:"";
      position:absolute; inset:4px;
      border-radius: 8px;
      background:
        radial-gradient(circle at 45% 35%, rgba(255,210,120,0.18), transparent 55%),
        radial-gradient(circle at 55% 65%, rgba(212,140,75,0.12), transparent 55%);
      opacity:0.8;
    }

    .level{
      font-variant-numeric: tabular-nums;
      color: var(--brass-0);
      font-weight:700;
      letter-spacing:0.02em;
      white-space:nowrap;
    }

    .meters{
      display:flex;
      align-items:center;
      gap:10px;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    .meter{
      display:flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.10), rgba(0,0,0,0.35)),
        linear-gradient(180deg, #1a120c, #0c0907);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6);
    }
    .gem, .coin{
      width:10px; height:10px;
      border-radius: 2px;
      box-shadow: 0 0 10px var(--glow);
    }
    .gem{
      background: linear-gradient(135deg, #bfe8ff, #4aa0d6);
      border: 1px solid rgba(200,245,255,0.35);
    }
    .coin{
      background: linear-gradient(135deg, var(--brass-0), var(--brass-1));
      border: 1px solid rgba(255,230,140,0.35);
      border-radius: 50%;
    }

    /* legacy statusbar removed */
    /* status-percent removed (replaced by hud-xp-row overlay) */
    /* HUD XP row (full-width under hud-top) */
    .hud{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 10px 12px 12px;
    }
    .hud-top{ display:flex; flex-direction:column; gap:6px }

    .hud-xp-row{
      width:100%;
      height:14px;
      border-radius:999px;
      position:relative;
      overflow:hidden;
      background: rgba(255,255,255,0.06);
      box-shadow: inset 0 0 0 1px rgba(255,215,120,0.08);
    }
    .hud-xp-row__fill{
      position:absolute; inset:0; transform-origin:left center; transform:scaleX(0);
      border-radius:999px; transition: transform 220ms ease;
      background: linear-gradient(90deg, rgba(255,215,120,0.95), rgba(80,200,140,0.95));
      box-shadow: 0 0 12px rgba(255,190,60,0.12), inset 0 -6px 14px rgba(255,240,180,0.04);
    }
    .hud-xp-row__label{ position:absolute; inset:0; display:grid; place-items:center; font-size:12px; font-weight:700; color: rgba(255,255,255,0.95); text-shadow: 0 1px 2px rgba(0,0,0,0.6); pointer-events:none }
    @media (max-width:520px){ .hud-xp-row{ height:12px } .hud-xp-row__label{ font-size:11px } }

    /* Tiles grid */
    .tiles{
      margin-top: 8px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:8px;
      width:100%;
      max-width:100%;
    }

    .tile{
      position:relative;
      border-radius: var(--tile-radius);
      padding: 8px 8px 10px;
      min-height: 84px;
      width:100%;
      max-width:100%;
      min-width:0;
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 10px 20px rgba(0,0,0,0.55), inset 0 0 18px rgba(0,0,0,0.75);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .08s ease;
    }
    /* Ensure any alternate card class is fluid */
    .sp-card { width:100%; max-width:100%; min-width:0; box-sizing:border-box; }
    /* Ensure tiles are fluid and don't use fixed px widths */
    .tiles .tile { width: 100%; max-width: 100%; box-sizing: border-box; }

    /* Mobile: force 3 columns and make cards keep aspect ratio */
    @media (max-width: 480px) {
      .tiles { grid-template-columns: repeat(3, minmax(0, 1fr)); gap:6px; padding:4px 6px; width:100%; max-width:100%; }
      .collection-grid, .weaker-grid { gap:6px; margin-top:6px; width:100%; }
      .tile { padding:6px 6px 8px; min-height: 0; aspect-ratio: 2 / 3; min-width: 0; }
      .weaker-card-tile { padding:4px; }
      .tile .icon{ width:28px; height:28px; margin-bottom:6px; }
      .collection-card-name, .tile .label { font-size: 12px; }
      .tiles .tile { box-sizing: border-box; }
    }

    /* Stronger constraints for narrow phones (<=425px) to guarantee 3 columns */
    @media (max-width: 425px) {
      /* 1) Забрати зайві відступи сторінки */
      html, body { margin: 0 !important; padding: 0 !important; }

      .page, .main-content, .page-content, .phone {
        width: 100% !important;
        max-width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }

      /* 2) Дати колоді використовувати всю ширину і трохи притиснути до країв */
      .tiles, .cards-grid, .deck-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        gap: 6px !important;
        padding: 0 6px !important;
        width: 100% !important;
        max-width: 100% !important;
        justify-items: stretch !important;
      }

      /* 3) Дозволити карткам розтягуватись по колонці */
      .tile, .tiles .tile, .cards-grid .sp-card, .deck-grid .sp-card, .sp-card {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
        padding: 4px !important;
        aspect-ratio: 0.6 / 1 !important;
      }

      /* Джерело горизонтального overflow */
      .screen { width: 100% !important; }
      .page-content { overflow-x: visible !important; }

      /* 4) додаткова страховка для внутрішніх елементів карти */
      .deck-grid .sp-card * { min-width: 0 !important; }
    }
    .tile:hover{ filter: brightness(1.05); }
    .tile:active{ transform: translateY(1px); }

    /* Ornate brass frame */
    .phone::before,
    .phone::after{
      content: none;
      display: none;
    }

    .tile .label{
      font-size: 13px;
      color: var(--brass-0);
      text-shadow: 0 1px 0 rgba(0,0,0,0.7);
    }
    .tile .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      opacity:0.95;
    }

    .tile .icon{
      width:34px; height:34px;
      border-radius: 12px;
      margin-bottom: 8px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,230,170,0.18), transparent 60%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.25);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6);
      position: relative;
      overflow:hidden;
    }
    .tile .icon::after{
      content:"";
      position:absolute; inset:-40%;
      background:
        repeating-conic-gradient(from 0deg,
          rgba(242,208,122,0.12) 0 10deg,
          rgba(0,0,0,0.0) 10deg 20deg);
      opacity:0.55;
      transform: rotate(10deg);
    }

    /* Page system */
    #main-content{
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .page{
      display:none;
      animation: fadeIn 0.3s ease;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    .page.active{
      display:flex;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* Page headers */
    .page-header{
      padding: 12px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.08), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border-bottom: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 4px 12px rgba(0,0,0,0.55);
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .page-title{
      font-size: 18px;
      color: var(--brass-0);
      text-shadow: 0 1px 2px rgba(0,0,0,0.7);
      margin: 0;
      flex: 1;
      text-align: center;
    }
    .back-btn{
      all: unset;
      padding: 8px 12px;
      font-size: 14px;
      color: var(--brass-1);
      cursor: pointer;
      border-radius: 8px;
      background: rgba(242,208,122,0.08);
      border: 1px solid rgba(242,208,122,0.15);
      transition: all 0.15s ease;
    }
    .back-btn:hover{
      background: rgba(242,208,122,0.15);
    }

    /* Page content */
    .page-content{
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }

    /* Global page container: responsive and centered */
    .page {
      width: 100%;
      max-width: 520px; /* change to 100% to occupy full screen */
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
    }

    /* Compressible grid helpers for card lists */
    .cards, .tiles, .collection-grid, .weaker-grid, .weaker-cards, .extras-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    /* Ensure items can shrink inside the grid */
    .card, .tile, .sp-card, .weaker-card-item, .compact-card {
      min-width: 0 !important;
      box-sizing: border-box !important;
    }

    /* Responsive tweaks for very narrow phones */
    @media (max-width: 360px) {
      .page { padding: 12px; }
      .tiles, .cards, .collection-grid { gap: 8px; }
      .tile .label, .collection-card-name { font-size: 12px; }
    }

    /* Fluid typography */
    .page-title { font-size: clamp(18px, 4vw, 22px); }
    .tile .label { font-size: clamp(12px, 3.2vw, 13px); }

    /* Info cards */
    .info-card{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 6px 12px rgba(0,0,0,0.55), inset 0 0 18px rgba(0,0,0,0.75);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 12px;
      text-align: center;
    }
    .info-label{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .info-value{
      font-size: 24px;
      color: var(--brass-0);
      text-shadow: 0 1px 2px rgba(0,0,0,0.7);
      font-weight: 500;
    }

    /* Action buttons */
    .action-btn{
      all: unset;
      display: block;
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      text-align: center;
      font-size: 15px;
      color: var(--bg-dark);
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border-radius: var(--radius);
      border: 1px solid rgba(242,208,122,0.35);
      box-shadow: 0 8px 16px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.15);
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 500;
    }
    .action-btn:hover{
      filter: brightness(1.08);
      transform: translateY(-1px);
    }
    .action-btn:active{
      transform: translateY(0);
    }
    .action-btn.secondary{
      background: linear-gradient(180deg, rgba(242,208,122,0.25), rgba(197,155,60,0.15));
      color: var(--brass-0);
    }

    /* Description */
    .description{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 15px;
      padding: 12px;
      background: rgba(0,0,0,0.35);
      border-radius: var(--radius);
      border: 1px solid rgba(242,208,122,0.12);
    }

    /* Tasks */
    .task-item{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .task-item.completed{
      opacity: 0.6;
      border-color: rgba(100,200,100,0.35);
    }
    .task-text{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 6px;
    }
    .task-progress{
      font-size: 13px;
      color: var(--brass-1);
      margin-bottom: 4px;
    }
    .task-reward{
      font-size: 12px;
      color: var(--muted);
    }

    /* Rewards */
    .reward-item{
      display: flex;
      align-items: center;
      gap: 12px;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .reward-item.locked{
      opacity: 0.5;
    }
    .reward-icon{
      font-size: 32px;
    }
    .reward-text{
      flex: 1;
      font-size: 14px;
      color: var(--brass-0);
    }
    .reward-progress{
      font-size: 12px;
      color: var(--muted);
    }
    .claim-btn{
      all: unset;
      padding: 8px 16px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Equipment */
    .equipment-slot{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .slot-name{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .slot-item{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 4px;
    }
    .slot-item.equipped{
      color: var(--brass-1);
    }
    .slot-bonus{
      font-size: 13px;
      color: #8bc34a;
    }

    /* Collections */
    .collection-set{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .collection-set.completed{
      border-color: rgba(100,200,100,0.45);
    }
    .set-name{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 6px;
    }
    .set-progress{
      font-size: 13px;
      color: var(--brass-1);
      margin-bottom: 4px;
    }
    .set-bonus{
      font-size: 12px;
      color: #8bc34a;
    }

    /* Upgrade hint styling */
    .hint {
      transition: all 0.3s ease;
    }
    
    .hint.hot {
      border-color: rgba(120,255,160,.35) !important;
      box-shadow: inset 0 0 14px rgba(0,0,0,.65), 0 0 18px rgba(90,255,120,.18) !important;
      color: rgba(220,255,220,.95) !important;
    }

    /* Card Details Page */
    .card-main-display {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
      padding: 20px;
      background: linear-gradient(180deg, rgba(242,208,122,0.08), rgba(0,0,0,0.3));
      border: 2px solid rgba(242,208,122,0.3);
      border-radius: 12px;
      margin-bottom: 15px;
    }

    /* Контейнер інформації карти */
    .card-info-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: left;
      margin-top: 0;
      margin-left: 0;
    }

    .card-display-image {
      width: 120px;
      height: 160px;
      margin: 0 auto 15px;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid rgba(242,208,122,0.4);
      background: radial-gradient(circle at 30% 30%, rgba(255,230,170,0.1), transparent);
    }

    .card-display-icon {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
    }

    .card-display-name {
      font-size: 18px;
      color: var(--brass-0);
      margin-bottom: 8px;
      font-weight: bold;
    }

    .card-display-element {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .card-display-level {
      display: inline-block;
      background: rgba(242,208,122,0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: var(--brass-1);
      margin: 0 5px;
    }

    .card-display-power {
      display: inline-block;
      background: rgba(160,200,100,0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: #8bc34a;
      margin: 0 5px;
    }

    .card-stats {
      padding: 15px;
      background: rgba(50,30,20,0.3);
      border-left: 3px solid var(--brass-0);
      margin-bottom: 15px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(242,208,122,0.1);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--muted);
      font-size: 13px;
    }

    .stat-value {
      color: var(--brass-0);
      font-weight: bold;
    }

    .card-comparison {
      margin-bottom: 15px;
    }

    .comparison-title {
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(242,208,122,0.2);
    }

    /* Horizontal scrollable list for weaker/burn cards */
    .weaker-cards,
    .weaker-grid {
      display: flex;
      gap: 12px;
      align-items: flex-start; /* important: do not stretch rows */
      overflow-x: auto;
      padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
    }

    /* Individual tile wrapper — fixed small card size, no flex-grow */
    .weaker-card-tile,
    .weaker-card {
      flex: 0 0 auto; /* do not grow */
      width: 92px;
      height: 128px;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      border-radius: 8px;
      background: rgba(30,20,18,0.45);
      border: 1px solid rgba(200,170,120,0.08);
      padding: 6px;
    }

    @media (min-width: 420px) {
      .weaker-card-tile,
      .weaker-card { width: 100px; height: 140px; }
    }

    /* Override dangerous inherited properties that stretch mini-cards */
    .weaker-card-tile,
    .weaker-card { height: 128px !important; min-height: 0 !important; align-self: auto !important; }

    /* Visual container inside tile — ensures inner .sp-card is constrained */
    .weaker-card-visual {
      width: 100%;
      height: calc(100% - 34px); /* leave room for footer */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* Render full deck-style card but scaled down to fit mini tile */
    .weaker-card-visual .sp-card {
      /* keep original internal layout by using scale */
      width: 200px !important;
      height: 280px !important;
      box-sizing: border-box !important;
      padding: 8px !important;
      margin: 0 auto !important;
      transform: scale(0.45);
      transform-origin: top center;
      will-change: transform;
      overflow: visible !important;
    }

    .weaker-card-footer { display:flex; justify-content:space-between; align-items:center; gap:6px; margin-top:6px; }
    .weaker-card-pct { color: #c6ffb3; font-weight:700; }
    .weaker-add-btn { background:#c85; border:none; color:#111; padding:6px 8px; border-radius:6px; cursor:pointer }

    /* Fix internal badges/values so they don't overflow */
    .weaker-card .badge, .weaker-card .corner-gear, .weaker-card .element-emoji { width:28px; height:28px; }
    .weaker-card .value, .weaker-card .power-value { font-size:18px; line-height:1; }

    .no-weaker-cards {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 13px;
    }

    /* Компактний список слабших карт */
    .weaker-cards-compact {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }
    .compact-card {
      background: rgba(50,30,20,0.7);
      border: 1.5px solid rgba(242,208,122,0.18);
      border-radius: 10px;
      padding: 10px 8px 8px 8px;
      min-width: 90px;
      max-width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      position: relative;
    }
    .compact-card-icon {
      font-size: 28px;
      margin-bottom: 4px;
    }
    .compact-card-name {
      font-size: 12px;
      color: var(--brass-0);
      margin-bottom: 2px;
      text-align: center;
      font-weight: 600;
    }
    .compact-card-power {
      font-size: 13px;
      color: #f4e6c6;
      margin-bottom: 4px;
      font-weight: 700;
    }
    .absorb-btn {
      background: linear-gradient(180deg, #f2d07a, #c59b3c);
      color: #1a120c;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 2px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .absorb-btn:hover {
      background: linear-gradient(180deg, #ffe7a0, #e0b85c);
    }
    .absorb-bonus {
      font-size: 11px;
      color: #2ecc71;
      font-weight: 700;
      margin-top: 0px;
      margin-bottom: 2px;
      text-align: center;
    }

    /* Card Upgrade Scale (XP System) */
    .card-upgrade {
      margin-top: 14px;
    }

    .upgrade-header {
      display: flex;
      justify-content: space-between;
      font-weight: 900;
      color: rgba(242, 208, 122, 0.95);
    }

    .card-upgrade .xp-bar {
      margin-top: 6px;
      height: 14px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(242, 208, 122, 0.25);
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.65);
      overflow: hidden;
    }

    .card-upgrade .xp-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(
        180deg,
        rgba(242, 208, 122, 0.95),
        rgba(122, 85, 32, 0.95)
      );
      box-shadow: 0 0 12px rgba(242, 208, 122, 0.35);
      transition: width 0.25s ease;
    }

    /* Upgrade arrow on card when guaranteed level-up is possible */
    .sp-card { position: relative; overflow: hidden; }
    .upgrade-arrow {
      position: absolute;
      left: 50%;
      transform: translate(-50%, 0);
      bottom: 10px;           /* placed inside card instead of far outside */
      top: auto;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(180deg, #30c85a, #0ea83a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(14, 168, 58, 0.4);
      pointer-events: none;
      z-index: 9999;
      border: 2px solid rgba(255, 255, 255, 0.3);
      animation: pulse-green 1.5s ease-in-out infinite;
    }

    @keyframes pulse-green {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(14, 168, 58, 0.4);
        transform: translateX(-50%) scale(1);
      }
      50% {
        box-shadow: 0 4px 20px rgba(14, 168, 58, 0.6);
        transform: translateX(-50%) scale(1.05);
      }
    }

    /* Альтернативно: якщо хочете стрілку під карткою (зовні) */
    .upgrade-arrow.outside {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;             /* розміщено під картою */
      margin-top: 8px;
      background: linear-gradient(180deg, #30c85a, #0ea83a);
      border: 2px solid rgba(255, 255, 255, 0.2);
      pointer-events: none;
      z-index: 5;
    }

    /* .card-wrapper контейнер для зовнішньої стрілки */
    .card-wrapper { position: relative; display: inline-block; }

    /* Prevent iOS from stretching grid rows during viewport recalculation */
    .deck-grid {
      grid-auto-rows: var(--card-h, 140px);
      align-items: start;
    }

    /* Mobile adjustments for Card Details page */
    @media (max-width: 480px) {
      #page-card-details .card-main-display {
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 12px;
      }

      #page-card-details .card-visual-area {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      #page-card-details .card-visual-area .sp-card {
        max-width: 220px !important;
        width: 48vw !important;
        aspect-ratio: 2 / 3 !important;
      }

      #page-card-details .card-meta {
        width: 100% !important;
      }

      #page-card-details .card-meta .card-meta-row {
        word-break: break-word;
      }

      /* Ensure upgrade arrow doesn't create extra space */
      #page-card-details .upgrade-arrow { bottom: 10px; top: auto; }

      /* Make XP bar flexible */
      #page-card-details .card-upgrade .xp-bar { width: 100% !important; }
    }

    #cu-upgrade-btn {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(242, 208, 122, 0.25);
      color: rgba(244, 230, 198, 0.95);
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s;
    }

    #cu-upgrade-btn:hover:not(:disabled) {
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 10px rgba(242, 208, 122, 0.2);
    }

    #cu-upgrade-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    /* === Shop Cards Styles === */
    .shop-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 8px;
      color: #d4af37;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .filter-btn:hover {
      background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
      border-color: #d4af37;
      transform: translateY(-2px);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #d4af37, #b8941f);
      color: #1a1a1a;
      border-color: #d4af37;
    }

    .shop-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      padding: 5px;
    }

    .shop-card {
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .shop-card:hover {
      border-color: #d4af37;
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }

    .shop-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .shop-card-name {
      font-size: 14px;
      font-weight: 600;
      color: #d4af37;
    }

    .shop-card-element {
      font-size: 20px;
    }

    .shop-card-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
      color: #999;
    }

    .shop-card-power {
      color: #4CAF50;
      font-weight: 600;
    }

    .shop-card-price {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #333;
    }

    .shop-price-tag {
      color: #d4af37;
      font-weight: 600;
      font-size: 14px;
    }

    .shop-buy-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .shop-buy-btn:hover {
      background: linear-gradient(135deg, #66BB6A, #4CAF50);
      transform: scale(1.05);
    }

    .shop-buy-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .shop-card-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      color: white;
    }

    .shop-card-badge.upgrade-only {
      background: linear-gradient(135deg, #FF9800, #E65100);
    }

    /* === Shop Tabs & Products === */
    .shop-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
      padding: 8px;
      border-radius: 12px;
      border: 2px solid #333;
    }

    .shop-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: #999;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .shop-tab:hover {
      color: #d4af37;
      background: rgba(212, 175, 55, 0.1);
    }

    .shop-tab.active {
      background: linear-gradient(135deg, #d4af37, #b8941f);
      color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .shop-tab-content {
      display: none;
    }

    .shop-tab-content.active {
      display: block;
    }

    .shop-products {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .product-card {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 2px solid rgba(242,208,122,0.22);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: #d4af37;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.2);
    }

    .product-badge {
      position: absolute;
      top: -8px;
      right: 16px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      color: white;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
    }

    .product-badge.hot {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      animation: pulse-badge 2s infinite;
    }

    .product-badge.new {
      background: linear-gradient(135deg, #3498db, #2980b9);
    }

    /* Product visual: scale deck-style .sp-card to match deck appearance */
    .product-icon.product-mini {
      width: 160px;
      height: 224px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible;
      margin-right: 12px;
    }
    .product-icon.product-mini .sp-card {
      width: 200px !important;
      height: 280px !important;
      transform: scale(0.65);
      transform-origin: left center;
      pointer-events: none;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .product-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .product-icon {
      width: 48px;
      height: 48px;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border-radius: 8px;
      border: 2px solid #444;
    }

    .product-info {
      flex: 1;
    }

    .product-title {
      font-size: 16px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .product-desc {
      font-size: 13px;
      color: #999;
    }

    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .product-price {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
    }

    .product-price .currency-icon {
      font-size: 20px;
    }

    .product-buy-btn {
      padding: 10px 20px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .product-buy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .product-buy-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .product-bonus {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(46, 204, 113, 0.2);
      border: 1px solid #2ecc71;
      border-radius: 4px;
      color: #2ecc71;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    /* === Pack Opening Modal === */
    .pack-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    .pack-modal.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .pack-modal-content {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 3px solid #d4af37;
      border-radius: 16px;
      padding: 24px;
      max-width: 350px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.4s;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .pack-modal-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .pack-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 8px;
    }

    .pack-modal-subtitle {
      font-size: 14px;
      color: #999;
    }

    .pack-rewards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
      align-items: center;
      justify-items: center;
    }

    .pack-card-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      animation: cardReveal 0.5s backwards;
    }

    .pack-card-wrapper:nth-child(1) { animation-delay: 0.1s; }
    .pack-card-wrapper:nth-child(2) { animation-delay: 0.2s; }
    .pack-card-wrapper:nth-child(3) { animation-delay: 0.3s; }
    .pack-card-wrapper:nth-child(4) { animation-delay: 0.4s; }
    .pack-card-wrapper:nth-child(5) { animation-delay: 0.5s; }

    .pack-card-wrapper .sp-card {
      width: 160px;
      height: 220px;
      margin: 0;
    }

    .pack-card-info {
      text-align: center;
      color: var(--brass-0);
    }

    .pack-card-name {
      font-size: 16px;
      font-weight: bold;
      color: var(--brass-0);
      margin-bottom: 4px;
    }

    .pack-card-element {
      font-size: 13px;
      color: var(--muted);
    }

    .reward-card {
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: cardReveal 0.5s backwards;
    }

    .reward-card:nth-child(1) { animation-delay: 0.1s; }
    .reward-card:nth-child(2) { animation-delay: 0.2s; }
    .reward-card:nth-child(3) { animation-delay: 0.3s; }
    .reward-card:nth-child(4) { animation-delay: 0.4s; }
    .reward-card:nth-child(5) { animation-delay: 0.5s; }
    .reward-card:nth-child(n+6) { animation-delay: 0.6s; }

    @keyframes cardReveal {
      from { transform: rotateY(90deg) scale(0.8); opacity: 0; }
      to { transform: rotateY(0) scale(1); opacity: 1; }
    }

    .reward-card-icon {
      font-size: 32px;
      width: 40px;
      text-align: center;
    }

    .reward-card-info {
      flex: 1;
    }

    .reward-card-name {
      font-size: 14px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .reward-card-power {
      font-size: 12px;
      color: #4CAF50;
      font-weight: 600;
    }

    /* Нові стилі для card-item (красиві карти) */
    .card-item {
      background: linear-gradient(135deg, rgba(255,220,140,0.08), rgba(0,0,0,0.4)),
                  linear-gradient(180deg, #1b1410, #0a0805);
      border: 2px solid rgba(242,208,122,0.25);
      border-radius: 12px;
      overflow: hidden;
      animation: cardReveal 0.5s backwards;
      margin-bottom: 12px;
    }

    .card-item:nth-child(1) { animation-delay: 0.1s; }
    .card-item:nth-child(2) { animation-delay: 0.2s; }
    .card-item:nth-child(3) { animation-delay: 0.3s; }
    .card-item:nth-child(4) { animation-delay: 0.4s; }
    .card-item:nth-child(5) { animation-delay: 0.5s; }
    .card-item:nth-child(n+6) { animation-delay: 0.6s; }

    .card-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
    }

    .card-item-element {
      font-size: 32px;
      min-width: 40px;
      text-align: center;
    }

    .card-item-details {
      flex: 1;
    }

    .card-item-name {
      font-size: 16px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .card-item-element-name {
      font-size: 12px;
      color: #999;
      opacity: 0.8;
    }

    .card-item-power {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 14px 14px;
      border-top: 1px solid rgba(242,208,122,0.12);
    }

    .card-power-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .card-power-value {
      font-size: 24px;
      font-weight: 800;
      color: #d4af37;
    }

    .pack-modal-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pack-modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    /* Duel Result Modal */
    .duel-result-rewards {
      text-align: center;
      padding: 20px;
      font-size: 28px;
      color: var(--brass-0);
      font-weight: 700;
    }
    .duel-result-stats-info {
      text-align: center;
      padding: 10px 20px;
      color: var(--muted);
      font-size: 15px;
    }
    .duel-wins-info {
      font-size: 16px;
      color: var(--brass-1);
    }
    .duel-next-btn {
      background: linear-gradient(180deg, rgba(100,200,100,0.35), rgba(60,150,60,0.35));
      border: 1px solid rgba(100,200,100,0.5);
    }
    .duel-next-btn:hover {
      background: linear-gradient(180deg, rgba(120,220,120,0.45), rgba(80,170,80,0.45));
    }
    .duel-battle-summary {
      margin-top: 20px;
      padding: 20px;
      border-top: 2px solid rgba(242,208,122,0.25);
    }
    .duel-summary-title {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 10px;
    }
    .duel-summary-hp {
      text-align: center;
      font-size: 20px;
      color: #e74c3c;
      font-weight: 700;
      margin-bottom: 15px;
    }
    .duel-battle-cards {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .duel-battle-card-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      border-left: 3px solid var(--elem);
    }
    .duel-battle-card-player {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .duel-battle-card-enemy {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .duel-battle-card-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: conic-gradient(var(--brass-2) 0 90deg, var(--brass-1) 90deg 180deg, var(--brass-2) 180deg 270deg, var(--brass-1) 270deg 360deg);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .duel-battle-card-icon svg {
      width: 18px;
      height: 18px;
    }
    .duel-battle-card-dmg {
      color: var(--brass-0);
      font-weight: 700;
      font-size: 16px;
    }
    .duel-battle-vs {
      color: var(--muted);
      font-size: 14px;
    }

    /* Multiplier preview badge between cards */
    .mult-badge {
      width: 160px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(0,0,0,0.70);
      border: 1px solid rgba(242,208,122,0.30);
      border-radius: 999px;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.75), 0 8px 20px rgba(0,0,0,0.60);
    }
    .mult-badge .mult-text {
      color: rgba(244,230,198,0.95);
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    .mult-badge .swords::before {
      content: '⚔';
      font-size: 16px;
      opacity: 0.90;
    }
    .mult-badge.mult-good .mult-text { color: #7dff9a; text-shadow: 0 0 8px rgba(125,255,154,0.5); }
    .mult-badge.mult-bad .mult-text { color: #ff9a7d; text-shadow: 0 0 8px rgba(255,154,125,0.5); }
    .mult-badge.mult-neutral .mult-text { color: rgba(244,230,198,0.95); }

    /* === New Shop Design === */
    .shop-section {
      margin-bottom: 25px;
    }

    .shop-section-title {
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
      border-left: 4px solid #d4af37;
      border-radius: 6px;
    }

    .shop-notice {
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.1));
      border: 2px solid rgba(52, 152, 219, 0.4);
      border-radius: 10px;
      padding: 12px 15px;
      margin-bottom: 15px;
      color: #3498db;
      font-size: 13px;
      line-height: 1.5;
      position: relative;
    }

    .shop-notice::before {
      content: '💡';
      font-size: 20px;
      margin-right: 8px;
    }

    .shop-item-card {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 2px solid rgba(242,208,122,0.22);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
      align-items: center;
      transition: all 0.3s;
      position: relative;
    }

    .shop-item-card:hover {
      border-color: #d4af37;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.2);
    }

    .shop-item-icon {
      width: 70px;
      height: 70px;
      min-width: 70px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .shop-item-content {
      flex: 1;
    }

    .shop-item-name {
      font-size: 16px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 5px;
    }

    .shop-item-desc {
      font-size: 13px;
      color: #999;
      margin-bottom: 8px;
    }

    .shop-item-chance {
      display: inline-block;
      padding: 4px 10px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-radius: 15px;
      color: white;
      font-size: 11px;
      font-weight: 700;
      margin-top: 5px;
    }

    .shop-item-chance.rare {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    .shop-item-chance.uncommon {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .shop-item-action {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .shop-item-price {
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
    }

    .shop-buy-button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .shop-buy-button:hover {
      background: linear-gradient(135deg, #27ae60, #229954);
      transform: scale(1.05);
    }

    .shop-buy-button:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .action-btn {
      all: unset;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(242,208,122,0.3);
    }

    .upgrade-btn {
      background: linear-gradient(180deg, #a6ff7a, #2ea13a);
      color: #0b180b;
    }

    .upgrade-btn:hover {
      box-shadow: 0 0 15px rgba(166,255,122,0.4);
    }

    .add-btn {
      background: linear-gradient(180deg, rgba(242,208,122,0.4), rgba(197,155,60,0.2));
      color: var(--brass-0);
    }

    .add-btn:hover {
      background: linear-gradient(180deg, rgba(242,208,122,0.6), rgba(197,155,60,0.3));
    }

    .remove-btn {
      background: rgba(255,50,50,0.1);
      color: #ff6666;
      border-color: rgba(255,50,50,0.2);
    }

    .remove-btn:hover {
      background: rgba(255,50,50,0.2);
    }

    /* Shop */
    .shop-item{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item-name{
      font-size: 15px;
      color: var(--brass-0);
    }
    .item-desc{
      font-size: 13px;
      color: var(--muted);
    }
    .item-price{
      font-size: 14px;
      color: var(--brass-1);
      margin: 4px 0;
    }
    .buy-btn{
      all: unset;
      padding: 10px;
      text-align: center;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Gold packs */
    .gold-pack{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 12px;
      text-align: center;
      position: relative;
    }
    .gold-pack.featured{
      border-color: var(--brass-1);
      box-shadow: 0 0 20px rgba(242,208,122,0.25);
    }
    .pack-badge{
      position: absolute;
      top: -8px;
      right: 10px;
      padding: 4px 12px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      font-size: 11px;
      border-radius: 12px;
      font-weight: 500;
    }
    .pack-amount{
      font-size: 20px;
      color: var(--brass-0);
      margin-bottom: 8px;
    }
    .pack-price{
      font-size: 15px;
      color: var(--brass-1);
      margin-bottom: 8px;
    }
    .pack-bonus{
      font-size: 13px;
      color: #8bc34a;
      margin-bottom: 8px;
    }
    .exchange-btn{
      all: unset;
      display: block;
      width: 100%;
      padding: 12px;
      text-align: center;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Profile stats */
    .profile-stat{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stat-label{
      font-size: 14px;
      color: var(--muted);
    }
    .stat-value{
      font-size: 16px;
      color: var(--brass-0);
      font-weight: 500;
    }

    /* Guild status */
    .guild-status{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 15px;
      text-align: center;
    }
    .status-text{
      font-size: 15px;
      color: var(--brass-0);
    }

    /* Accordion list */
    .list{
      margin-top: 12px;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 12px 22px rgba(0,0,0,0.55);
      background:
        linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
    }

    .item{
      border-top: 1px solid rgba(242,208,122,0.10);
    }
    .item:first-child{ border-top:none; }

    .item > button{
      all:unset;
      display:flex;
      align-items:center;
      width:100%;
      padding: 12px 12px;
      cursor:pointer;
      gap:10px;
    }
    .item > button:hover{ background: rgba(255,210,120,0.05); }

    .item .bullet{
      width:22px; height:22px;
      border-radius: 7px;
      background:
        linear-gradient(180deg, var(--brass-0), var(--brass-2));
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.5), 0 0 10px rgba(255,210,120,0.18);
      position:relative;
    }
    .item .bullet::after{
      content:"";
      position:absolute; inset:5px;
      border-radius: 6px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,255,255,0.22), transparent 55%),
        linear-gradient(180deg, #3a2e1f, #14100c);
      opacity:0.9;
    }

    .item .text{
      flex:1;
      font-size: 15px;
      letter-spacing:0.02em;
    }
    .item .chev{
      width: 10px; height:10px;
      border-right: 2px solid rgba(242,208,122,0.7);
      border-bottom: 2px solid rgba(242,208,122,0.7);
      transform: rotate(-45deg);
      transition: transform .12s ease;
      opacity:0.9;
      margin-right: 4px;
    }

    /* Promo */
    .promo{
      margin-top: 10px;
      border-radius: var(--radius);
      padding: 10px 12px;
      background:
        radial-gradient(400px 200px at 50% 0%, rgba(255,210,120,0.12), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 12px 22px rgba(0,0,0,0.55);
      text-align:center;
    }
    .promo .badge{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--copper-0), var(--copper-2));
      border: 1px solid rgba(255,220,140,0.25);
      color: #1c0f08;
      font-weight: 700;
      letter-spacing:0.03em;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.45);
      margin-bottom: 6px;
    }
    .promo .line{
      color: var(--brass-0);
      font-weight: 700;
      text-shadow: 0 1px 0 rgba(0,0,0,0.75);
    }
    .promo .sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Bottom nav */
    .bottom{
      position: sticky;
      bottom: 8px;
      margin-top: 12px;
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 16px 26px rgba(0,0,0,0.65);
      display:flex;
      gap:6px;
      padding: 8px;
    }
    .navbtn{
      flex:1;
      border-radius: 14px;
      padding: 10px 8px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      border: 1px solid rgba(242,208,122,0.10);
      background:
        linear-gradient(180deg, rgba(255,210,120,0.04), rgba(0,0,0,0.45));
      transition: filter .08s ease, transform .08s ease;
    }
    .navbtn:hover{ filter: brightness(1.06); }
    .navbtn:active{ transform: translateY(1px); }

    .navbtn .ico{
      width:24px; height:24px;
      margin: 0 auto 6px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,230,170,0.18), transparent 60%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6);
      position:relative;
      overflow:hidden;
    }
    .navbtn .ico::after{
      content:"";
      position:absolute; inset:-50%;
      background: repeating-conic-gradient(from 0deg, rgba(242,208,122,0.10) 0 12deg, transparent 12deg 24deg);
      opacity:0.55;
    }
    .navbtn .t{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:0.02em;
    }
    .navbtn.active{
      border-color: rgba(242,208,122,0.32);
      background:
        radial-gradient(220px 80px at 50% 0%, rgba(255,210,120,0.16), transparent 65%),
        linear-gradient(180deg, rgba(255,210,120,0.06), rgba(0,0,0,0.55));
    }
    .navbtn.active .t{ color: var(--brass-0); }

    /* Small screens */
    @media (max-width: 360px){
      .tile{ min-height: 90px; }
      .tile .label{ font-size: 12px; }
      .tile .sub{ font-size: 11px; }
    }

    /* ===== DECK SCREEN ===== */
    .screen {
      width: 100vw;
      max-width: none;
      margin: 0;
      padding: 0;
    }

    /* Topbar для колоди */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 16px;
      background: 
        linear-gradient(180deg, rgba(255,210,120,.06), rgba(0,0,0,.55)),
        linear-gradient(180deg, #1b120c, #070503);
      border: 1px solid rgba(242,208,122,.20);
      box-shadow: 0 14px 26px rgba(0,0,0,.65);
      margin-bottom: 10px;
    }

    .topbar-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(242,208,122,.18);
      box-shadow: inset 0 0 10px rgba(0,0,0,.65);
      font-size: 14px;
      color: var(--brass-0);
      font-weight: 600;
    }

    .gem, .coin {
      width: 10px;
      height: 10px;
      display: inline-block;
    }

    .gem {
      border-radius: 2px;
      background: linear-gradient(135deg, #bfe8ff, #4aa0d6);
      box-shadow: 0 0 6px rgba(79, 180, 240, 0.5);
    }

    .coin {
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brass-0), var(--brass-1));
      box-shadow: 0 0 6px rgba(242,208,122, 0.5);
    }

    /* Panel helper */
    .panel {
      background:
        linear-gradient(180deg, rgba(255,210,120,.05), rgba(0,0,0,.55)),
        linear-gradient(180deg, #1b120c, #070503);
      border: 1px solid rgba(242,208,122,.18);
      box-shadow: 0 14px 24px rgba(0,0,0,.6), inset 0 0 14px rgba(0,0,0,.7);
      border-radius: 14px;
    }

    .subtle {
      opacity: 0.95;
    }

    /* Deck header */
    .deck-header {
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .deck-title {
      font-weight: 800;
      letter-spacing: 0.06em;
      color: var(--brass-0);
      font-size: 14px;
    }

    .deck-power {
      font-weight: 800;
      color: var(--brass-0);
      font-size: 16px;
    }

    /* Hint */
    .hint {
      padding: 8px 12px;
      text-align: center;
      color: rgba(244,230,198,.92);
      font-size: 13px;
      margin-bottom: 10px;
    }

    /* Card base styles */
    .sp-card {
      /* Компактний розмір */
      width: 200px;
      height: 280px;
      border-radius: 20px;
      position: relative;
      padding: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;

      --elem: var(--fire); /* default */
      --rar: var(--legend); /* default rarity */

      background:
        radial-gradient(200px 180px at 40% 20%, rgba(255,220,140,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.72)),
        linear-gradient(180deg, #1b120c, #080604);

      box-shadow:
        0 15px 30px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 18px color-mix(in srgb, var(--elem) 22%, transparent);

      border: 1px solid rgba(242,208,122,.22);
    }

    .sp-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow:
        0 20px 40px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 25px color-mix(in srgb, var(--elem) 35%, transparent);
    }

    .sp-card.selected {
      box-shadow:
        0 20px 40px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 35px color-mix(in srgb, var(--elem) 50%, transparent),
        0 0 0 3px var(--rar);
    }

    /* Metal rim with rarity color */
    .sp-card::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 16px;
      background:
        linear-gradient(135deg,
          color-mix(in srgb, var(--rar) 30%, rgba(242,208,122,.62)),
          color-mix(in srgb, var(--rar) 20%, rgba(181,106,51,.25)),
          color-mix(in srgb, var(--rar) 15%, rgba(122,85,32,.2)));
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.6),
        inset 0 0 16px rgba(0,0,0,.6);
      pointer-events:none;
      opacity:.95;
      z-index: 1;
    }

    /* Inner plate */
    .sp-card::after{
      content:"";
      position:absolute;
      inset: 14px;
      border-radius: 14px;
      background:
        radial-gradient(400px 320px at 50% 20%, rgba(255,210,120,.08), transparent 58%),
        linear-gradient(180deg, rgba(255,210,120,.04), rgba(0,0,0,.40)),
        linear-gradient(180deg, #241a12, #120c08);
      box-shadow:
        inset 0 0 0 1px rgba(242,208,122,.10),
        inset 0 0 14px rgba(0,0,0,.65);
      pointer-events:none;
      z-index: 1;
    }

    /* Content layer */
    .sp-card > *{ position:relative; z-index:2; }

    /* Upgradable card - green arrow indicator (як окремий елемент) */
    .upgrade-dot {
      position: absolute;
      top: -12px;
      right: 8px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      
      color: #0b180b;
      background: linear-gradient(180deg, #a6ff7a, #2ea13a);
      border: 1px solid rgba(0,0,0,.45);
      box-shadow: 0 6px 14px rgba(0,0,0,.6), 0 0 16px rgba(90,255,120,.25);
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      animation: pulse-upgrade 1.5s ease-in-out infinite;
      z-index: 10;
    }
    .corner-gear {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      z-index: 3;
      
      background:
        conic-gradient(
          from 0deg,
          var(--brass-2) 0 15deg,
          var(--brass-1) 15deg 30deg,
          var(--brass-2) 30deg 45deg,
          var(--brass-1) 45deg 60deg,
          var(--brass-2) 60deg 75deg,
          var(--brass-1) 75deg 90deg,
          var(--brass-2) 90deg 105deg,
          var(--brass-1) 105deg 120deg,
          var(--brass-2) 120deg 135deg,
          var(--brass-1) 135deg 150deg,
          var(--brass-2) 150deg 165deg,
          var(--brass-1) 165deg 180deg,
          var(--brass-2) 180deg 195deg,
          var(--brass-1) 195deg 210deg,
          var(--brass-2) 210deg 225deg,
          var(--brass-1) 225deg 240deg,
          var(--brass-2) 240deg 255deg,
          var(--brass-1) 255deg 270deg,
          var(--brass-2) 270deg 285deg,
          var(--brass-1) 285deg 300deg,
          var(--brass-2) 300deg 315deg,
          var(--brass-1) 315deg 330deg,
          var(--brass-2) 330deg 345deg,
          var(--brass-1) 345deg 360deg
        );
      
      box-shadow:
        inset 0 0 0 2px rgba(0,0,0,.6),
        0 5px 12px rgba(0,0,0,.7),
        0 0 12px color-mix(in srgb, var(--elem) 40%, transparent);
      
      display: grid;
      place-items: center;
      transition: transform 0.6s ease;
    }

    .sp-card:hover .corner-gear {
      transform: rotate(180deg);
    }

    /* Центр шестерні */
    .corner-gear::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 60%),
        linear-gradient(180deg, #2a1c12, #0a0604);
      box-shadow: inset 0 0 8px rgba(0,0,0,.8);
      z-index: -1;
    }

    /* Іконка стихії всередині шестерні */
    .corner-gear svg{
      width: 22px;
      height: 22px;
      fill: var(--elem);
      filter:
        drop-shadow(0 0 6px color-mix(in srgb, var(--elem) 60%, transparent))
        drop-shadow(0 2px 4px rgba(0,0,0,.8));
      position: relative;
      z-index: 2;
    }
    
    .power-plate {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 50px;
      border-radius: 12px;
      
      background:
        radial-gradient(180px 60px at 50% 0%, rgba(255,210,120,.15), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.65)),
        linear-gradient(180deg, #1b120c, #080604);
      
      border: 1px solid rgba(242,208,122,.25);
      box-shadow: 
        inset 0 0 12px rgba(0,0,0,.75),
        0 6px 16px rgba(0,0,0,.6),
        inset 0 0 0 1px rgba(0,0,0,.6);
      
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 3;
    }

    .sp-card:hover .power-plate {
      box-shadow: 
        inset 0 0 12px rgba(0,0,0,.75),
        0 8px 20px rgba(0,0,0,.7),
        inset 0 0 0 1px rgba(0,0,0,.6),
        0 0 15px color-mix(in srgb, var(--elem) 30%, transparent);
    }

    .sp-card.selected .power-plate {
      background:
        radial-gradient(180px 60px at 50% 0%, rgba(255,210,120,.20), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.65)),
        linear-gradient(180deg, color-mix(in srgb, var(--rar) 15%, #1b120c), color-mix(in srgb, var(--rar) 10%, #080604));
    }
    
    .power-value {
      font-size: 32px;
      font-weight: 900;
      color: var(--brass-0);
      font-variant-numeric: tabular-nums;
      text-shadow:
        0 2px 0 rgba(0,0,0,.75),
        0 0 12px rgba(255,210,120,.25);
      transition: all 0.3s ease;
    }

    .sp-card.selected .power-value {
      color: color-mix(in srgb, var(--rar) 40%, var(--brass-0));
      text-shadow:
        0 2px 0 rgba(0,0,0,.75),
        0 0 20px color-mix(in srgb, var(--rar) 50%, transparent);
    }
    
    .rarity-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.8);
      border: 1px solid var(--rar);
      color: var(--rar);
      font-size: 10px;
      font-weight: bold;
      letter-spacing: 1px;
      z-index: 3;
      text-transform: uppercase;
      display: none; /* hide rarity on the card - show only in description */
    }

    /* Deck Grid 3x3 */
    .deck-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 0;
      align-items: start;
      justify-items: stretch;
    }

    /* Карти в колоді використовують стилі з steampunk-cards.css */


    /* ===== DUEL SCREEN ===== */
      .duel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    /* Duel grid: 3 columns, compressible */
    .duel-grid{
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      width: 100%;
      margin: 12px 0;
    }
    .duel-grid > div { min-width: 0; }
    .enemy-slot, .player-slot {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }
    .mult-slot { display:flex; align-items:center; justify-content:center; }
    .mult { width:100%; display:inline-flex; align-items:center; justify-content:center; padding:10px 8px; border-radius:999px; cursor:pointer; }
    .mult-neutral { background: rgba(0,0,0,0.35); color: var(--brass-0); border:1px solid rgba(242,208,122,0.12); }
    .mult-good { background: linear-gradient(180deg,#2e7d32,#1b5e20); color:#fff; }
    .mult-bad { background: linear-gradient(180deg,#7b2b2b,#5a1515); color:#fff; }

    @media (max-width: 360px) {
      .duel-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .duel-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--brass-0);
    }
    .duel-start-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(242,208,122,.25);
      background: linear-gradient(180deg, rgba(242,208,122,.25), rgba(0,0,0,.35));
      color: var(--brass-0);
      cursor: pointer;
    }
    .duel-hud {
      display: flex;
      gap: 12px;
      margin-bottom: 10px;
    }
    .duel-hp {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(242,208,122,.18);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,220,140,.06), rgba(0,0,0,.35));
      color: var(--brass-0);
    }
    .enemy-hand, .player-hand {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 10px 0 0px;
    }
    .player-hand {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 0px 0 8px;
    }
    .duel-multipliers {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 12px 0;
      min-height: 32px;
    }
    .duel-log {
      min-height: 50px;
      padding: 8px;
      margin: 0px 0 10px;
      border: 1px dashed rgba(242,208,122,.2);
      border-radius: 10px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.4;
      text-align: center;
    }

    /* Mobile tweaks for Duel screen */
    @media (max-width: 480px) {
      .duel-header { flex-direction: column; align-items: stretch; gap: 8px; }
      .duel-hud { flex-direction: column; gap: 8px; }
      .hud-status { justify-content: space-between; }
      .hud-status .hp-wrapper { min-width: 0 !important; }
      .duel-multipliers { flex-wrap: wrap; gap: 8px; }
      .duel-log { text-align: left; font-size: 12px; }

      /* Allow hands to scroll horizontally on very narrow screens */
      .enemy-hand, .player-hand {
        gap: 6px;
        justify-content: flex-start;
        overflow-x: auto;
        padding: 6px 4px;
        -webkit-overflow-scrolling: touch;
      }

      /* Make cards smaller and responsive inside duel hands */
      .duel-hand .sp-card, .enemy-hand .sp-card, .player-hand .sp-card {
        width: 30vw !important;
        max-width: 120px !important;
        height: auto !important;
        aspect-ratio: 2 / 3 !important;
        padding: 6px !important;
        border-radius: 12px !important;
      }

      /* Tighter container paddings to use more screen space */
      .page-content { padding-left: 8px !important; padding-right: 8px !important; }

      /* Make multiplier buttons compact */
      .duel-multipliers .pill, .duel-multipliers button {
        padding: 8px 10px !important;
        font-size: 13px !important;
        border-radius: 8px !important;
      }

      /* Reduce avatar size and hp bar font on mobile */
      .hud-status .avatar { width:46px; height:46px; }
      .hp-label { font-size:12px; }
      .duel-hp { padding: 8px; font-size:14px; }

      /* Reduce spacing around result/preduel panels */
      .preduel-row { padding: 6px 10px; }
      .duel-battle-cards { gap: 8px; }
    }

    /* HUD: avatar + HP bar for enemy/player */
    .hud-status{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:center;
      margin:8px 0;
    }
    .hud-status .avatar{
      width:56px;
      height:56px;
      border-radius:10px;
      background: linear-gradient(180deg, #2f1f14, #120c08);
      border: 2px solid rgba(242,208,122,0.16);
      box-shadow: inset 0 0 6px rgba(0,0,0,0.6), 0 6px 12px rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center; color:var(--brass-0); font-weight:800;
    }
    .hud-status .avatar.enemy-avatar{ box-shadow: inset 0 0 8px rgba(120,40,20,0.6), 0 6px 12px rgba(0,0,0,0.6); }
    .hud-status .avatar.player-avatar{ box-shadow: inset 0 0 8px rgba(40,120,20,0.6), 0 6px 12px rgba(0,0,0,0.6); }
    .hud-status .hp-wrapper{ flex:1; min-width:220px; }
    .hp-label{ font-size:13px; color:var(--muted); margin-bottom:6px; text-align:left; }
    .hp-bar{ height:12px; background: rgba(0,0,0,0.35); border-radius:10px; border:1px solid rgba(242,208,122,0.12); overflow:hidden; }
    .hp-fill{ height:100%; width:0%; background: linear-gradient(90deg, #4CAF50, #2e7d32); box-shadow: 0 0 8px rgba(46,204,113,0.12); transition: width 0.28s ease; }

    .preduel-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
    }
    .preduel-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.25));
      color: var(--ink);
      font-weight: 600;
    }
    .preduel-label { color: var(--muted); font-weight: 500; }
    .preduel-value { color: var(--brass-0); }
    .preduel-actions { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
    .duel-hand .sp-card, .enemy-hand .sp-card, .player-hand .sp-card {
      width: 160px;
      height: 220px;
    }
    /* Extras section */
    .extras-title {
      margin: 14px 4px 8px;
      color: rgba(242,208,122,.85);
      letter-spacing: 0.06em;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
    }

    .extras-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 8px;
    }

    /* === ЕЛЕМЕНТИ СТИХІЇ === */
    .sp-card.fire  { --elem: var(--fire); }
    .sp-card.water { --elem: var(--water); }
    .sp-card.air   { --elem: var(--air); }
    .sp-card.earth { --elem: var(--earth); }
    .sp-card.steam { --elem: var(--steam); }
    .sp-card.mech  { --elem: var(--mech); }

    /* === РІДКОСТІ === */
    .sp-card.common  { --rar: var(--common); }
    .sp-card.rare    { --rar: var(--rare); }
    .sp-card.epic    { --rar: var(--epic); }
    .sp-card.legend  { --rar: var(--legend); }

    /* Анімація світіння */
    @media (prefers-reduced-motion: no-preference){
      .sp-card{
        animation: subtle-glow 3s ease-in-out infinite;
      }
      @keyframes subtle-glow{
        0%,100%{ filter: brightness(1.00); }
        50%    { filter: brightness(1.05); }
      }
    }

    .extra-slot {
      padding: 10px 8px;
      text-align: center;
      min-height: 90px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
    }

    .slot-icon {
      width: 38px;
      height: 38px;
      margin: 0 auto;
      border-radius: 12px;
      background: linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,.20);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.6);
      opacity: 0.75;
    }

    .slot-text {
      font-size: 12px;
      color: rgba(244,230,198,.86);
    }

    /* Link-like button */
    .link-like {
      text-align: center;
      color: rgba(159, 214, 255, .85);
      font-size: 12px;
      text-decoration: underline;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .link-like:hover {
      color: rgba(159, 214, 255, 1);
    }

    /* Menu list */
    .menu-list {
      padding: 6px;
    }

    .menu-row {
      width: 100%;
      background: transparent;
      color: rgba(244,230,198,.92);
      border: 1px solid rgba(242,208,122,.10);
      border-radius: 12px;
      padding: 12px 10px;
      margin: 6px 0;
      text-align: left;
      cursor: pointer;
      font-family: Georgia, "Times New Roman", serif;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .menu-row:hover {
      border-color: rgba(242,208,122,.25);
      background: rgba(255,210,120,.04);
    }

    .menu-row:active {
      transform: translateY(1px);
    }

    /* Auth overlay */
    .auth-overlay{
      position: fixed;
      inset: 0;
      background: rgba(8, 6, 5, 0.95);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .auth-overlay.hidden{
      opacity: 0;
      pointer-events: none;
      display: none;
    }

    .auth-box{
      width: min(380px, 90vw);
      background:
        linear-gradient(180deg, rgba(255,220,140,0.08), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 24px 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.75);
      position: relative;
    }
    .auth-box::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(242,208,122,0.35), rgba(213,143,85,0.18), rgba(90,50,20,0.10));
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      padding: 1px;
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }

    .auth-title{
      font-size: 24px;
      font-weight: 700;
      color: var(--brass-0);
      text-align: center;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.7);
    }
    .auth-subtitle{
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 24px;
    }

    .auth-tabs{
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 4px;
    }
    .auth-tab{
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      color: var(--muted);
      font-size: 14px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    .auth-tab:hover{
      background: rgba(255,210,120,0.05);
    }
    .auth-tab.active{
      background: linear-gradient(180deg, var(--brass-0), var(--brass-2));
      color: #14100c;
      font-weight: 700;
      border-color: rgba(255,230,140,0.3);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.4);
    }

    .auth-form{
      display: none;
    }
    .auth-form.active{
      display: block;
    }

    .form-group{
      margin-bottom: 16px;
    }
    .form-label{
      display: block;
      font-size: 13px;
      color: var(--brass-0);
      margin-bottom: 6px;
      font-weight: 600;
    }
    .form-input{
      width: 100%;
      padding: 12px 14px;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6)),
        linear-gradient(180deg, #1a120c, #0c0907);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: 10px;
      color: var(--ink);
      font-family: Georgia, "Times New Roman", serif;
      font-size: 15px;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6);
      transition: border-color 0.2s ease;
    }
    .form-input:focus{
      outline: none;
      border-color: rgba(242,208,122,0.45);
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6), 0 0 0 2px rgba(242,208,122,0.15);
    }
    .form-input::placeholder{
      color: rgba(208, 191, 154, 0.5);
    }

    .auth-btn{
      width: 100%;
      padding: 14px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-2));
      border: 1px solid rgba(255,230,140,0.35);
      border-radius: 12px;
      color: #14100c;
      font-family: Georgia, "Times New Roman", serif;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35), 0 6px 16px rgba(0,0,0,0.4);
      text-shadow: 0 1px 0 rgba(255,255,255,0.2);
    }
    .auth-btn:hover{
      filter: brightness(1.08);
      transform: translateY(-1px);
    }
    .auth-btn:active{
      transform: translateY(0);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.4);
    }

    .auth-error{
      display: none;
      margin-top: 12px;
      padding: 10px 12px;
      background: rgba(180, 50, 40, 0.2);
      border: 1px solid rgba(220, 80, 60, 0.4);
      border-radius: 8px;
      color: #ffcccc;
      font-size: 13px;
      text-align: center;
    }
    .auth-error.show{
      display: block;
    }
    .burn-arrow {
      position: absolute;
      left: 8px;
      bottom: 8px;
      font-size: 1.5rem;
      color: #3cff3c;
      line-height: 1;
      font-weight: bold;
      pointer-events: none;
      z-index: 2;
      text-shadow: 0 2px 8px #000a, 0 0 6px #3cff3c99;
      filter: drop-shadow(0 0 2px #000) drop-shadow(0 0 4px #3cff3c);
      background: none;
      border-radius: 50%;
      padding: 0;
    }
    .weaker-card-item {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 180px;
    }
    /* Mobile: force 3 cards per row and compact card tiles */
    @media (max-width: 480px) {
      .collection-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 6px;
      }
      .collection-card-item {
        padding: 6px 4px;
        min-height: 70px;
      }
      .collection-card-name { font-size: 12px; }
      .collection-card-status { font-size: 10px; }
    }
  /* Strong override: force 3 columns on very narrow screens and remove fixed container limits */
  @media (max-width:425px){
    /* keep a comfortable inner padding but allow full-width layout */
    html, body, .phone, #main-content, .page { width:100% !important; max-width:100% !important; padding:16px !important; margin:0 !important; overflow-x:visible !important; }

    /* тільки сторінка колоди: мінімум відступів */
    #page-deck { padding: 0 !important; }
    #page-deck .screen { padding: 8px !important; }

    /* main grids used in project */
    .tiles, .cards-grid { grid-template-columns: repeat(3, minmax(0,1fr)) !important; gap:6px !important; padding:6px 8px !important; width:100% !important; max-width:100% !important; }

    /* individual card blocks (project uses both .tile and .sp-card) */
    .tiles .tile, .cards-grid .sp-card, .sp-card, .tile { min-width:0 !important; width:100% !important; padding:4px !important; aspect-ratio: 0.6 / 1 !important; box-sizing: border-box !important; }

    /* collection / weaker grids */
    .collection-grid, .weaker-grid { width:100% !important; max-width:100% !important; gap:6px !important; }

    /* Tweak small visuals */
    .tile .icon, .sp-card .element-emoji { width:20px !important; height:20px !important; margin-bottom:4px !important; }
    .tile .label, .collection-card-name, .collection-card-status, .sp-card .rarity-badge { font-size:11px !important; }

    /* ensure children can shrink */
    .tiles .tile, .cards-grid .sp-card { flex: 0 1 auto !important; }
  }

  </style>
  
  <style>
  /* ===== iPhone 12 mini portrait: DECK 3x3 без прокруту ===== */
  @media (max-width: 390px) and (orientation: portrait) {

    /* 1) Ніякого скролу на сторінці колоди */
    #page-deck{
      height: 100dvh;
      overflow: hidden;
    }

    /* 2) Екран колоди займає весь в’юпорт */
    #page-deck .screen{
      height: 100%;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      padding: 8px;
      gap: 6px;
      overflow: hidden;
    }

    /* 3) Стиснути верхні блоки (мінімум відступів) */
    #page-deck .topbar{ margin: 0 !important; }
    #page-deck .deck-header{ margin: 0 !important; padding: 8px 10px !important; }
    #page-deck .hint{ margin: 0 !important; padding: 6px 10px !important; }

    /* 4) Сховати все, що нижче гріда */
    #page-deck .extras-title,
    #page-deck .extras-grid,
    #page-deck .link-like,
    #page-deck .menu-list{
      display: none !important;
    }

    /* 5) Сам грід займає весь залишок висоти і є строго 3x3 */
    #page-deck .deck-grid{
      flex: 1 1 auto;
      min-height: 0;

      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
      grid-template-rows: repeat(3, minmax(0, 1fr)) !important;

      gap: 6px !important;
      margin: 0 !important;

      justify-items: stretch;
      align-items: stretch;
    }

    /* 6) Картка заповнює клітинку */
    #page-deck .deck-grid .sp-card{
      width: 100% !important;
      height: 100% !important;
      min-width: 0 !important;
      box-sizing: border-box !important;

      aspect-ratio: auto !important;
      overflow: hidden;
    }
  }
  </style>

  <style>
  /* ===== DECK: стабільний 3×3, пропорційні карти ===== */
  @media (max-width: 425px) {

    /* Сторінка колоди без скролу */
    #page-deck{
      height: 100dvh;
      overflow: hidden;
    }

    /* Верх + грід по колонці */
    #page-deck .screen{
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 8px;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* DeckGrid займає весь залишок */
    #page-deck #deckGrid{
      flex: 1 1 auto;
      min-height: 0;

      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-template-rows: repeat(3, minmax(0, 1fr));
      gap: 6px;

      margin: 0;
      padding: 0;
      align-items: stretch;
      justify-items: stretch;
      overflow: hidden;
    }

    /* Якщо хочете 3×3 БЕЗ прокрутки — extras треба сховати */
    #page-deck .extras-title,
    #page-deck .extras-grid{
      display: none !important;
    }

    /* Перекрити aspect-ratio для карт в колоді — пропорційні карти */
    #page-deck #deckGrid .sp-card{
      width: 100% !important;
      height: 100% !important;
      min-width: 0 !important;
      box-sizing: border-box !important;

      aspect-ratio: 2 / 3 !important;

      overflow: hidden;
      padding: 2px !important;
    }

    /* Запобігаємо внутрішньому overflow через абсолютні елементи */
    #page-deck #deckGrid .sp-card *{
      min-width: 0 !important;
    }

    /* Точкова економія висоти для верхніх блоків (якщо все ще не влазить) */
    #page-deck .topbar{ padding: 6px 8px 8px !important; }
    #page-deck .deck-header{ padding: 8px 10px !important; }
    #page-deck .hint{ padding: 6px 10px !important; }
    #page-deck #deckGrid{ gap: 4px !important; }
  }
  </style>

  <style>
  /* ===== Deck UI compact on phone ===== */
  @media (max-width: 425px) and (orientation: portrait) {

    /* 1) Іконка стихії (emoji) менша */
    #page-deck #deckGrid .sp-card .element-emoji{
      width: 14px !important;
      height: 14px !important;
      font-size: 14px !important;
      line-height: 1 !important;
      margin: 0 !important;
    }

    /* 2) Шестерня-контейнер іконки — трохи менший і ближче до верху */
    #page-deck #deckGrid .sp-card .corner-gear{
      transform: scale(0.82);
      transform-origin: top left;
    }

    /* 3) Плашка сили — менша */
    #page-deck #deckGrid .sp-card .power-plate{
      height: 34px;
      border-radius: 14px;
      padding: 2px 6px;
    }

    /* 4) Число сили — менше */
    #page-deck #deckGrid .sp-card .power-value{
      font-size: 20px !important;
      letter-spacing: 0.2px;
    }

    /* 5) Бейдж рідкості — компактніший */
    #page-deck #deckGrid .sp-card .rarity-badge{
      top: 8px !important;
      right: 8px !important;
      padding: 2px 6px !important;
      border-radius: 8px !important;
      font-size: 9px !important;
      letter-spacing: 0.6px !important;
    }

    /* ===== Нормалізувати HUD (topbar + pill) ===== */
    #page-deck .topbar{
      padding: 6px 8px !important;
      border-radius: 14px !important;
      margin-bottom: 6px !important;
    }

    #page-deck .topbar .back-btn{
      padding: 5px 8px !important;
      font-size: 12px !important;
    }

    #page-deck .pill{
      padding: 4px 8px !important;
      gap: 5px !important;
      font-size: 12px !important;
    }

    #page-deck .gem,
    #page-deck .coin{
      width: 8px !important;
      height: 8px !important;
    }

    #page-deck .deck-header{
      padding: 8px 10px !important;
      margin-bottom: 6px !important;
    }
    #page-deck .deck-title{ font-size: 13px !important; }
    #page-deck .deck-power{ font-size: 13px !important; }

    /* Важливе: перекриваємо глобальний aspect-ratio саме для карт в колоді */
    #page-deck #deckGrid .sp-card{
      aspect-ratio: 2 / 3 !important;
    }
  }
  </style>

  <style>
  /* === FULL-WIDTH HUD + FULL-WIDTH DECK GRID (mobile) === */
  @media (max-width: 425px) and (orientation: portrait) {

    /* 1) Прибрати будь-яке “звуження/центрування” рамки телефону */
    .phone, #app, #page-deck, #page-deck .screen{
      width: 100% !important;
      max-width: 100% !important;
      margin: 0 !important;
    }

    /* 2) Якщо body/html десь центруються — примусово в нормальний flow */
    html, body{
      width: 100% !important;
      max-width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* 3) HUD на всю ширину */
    #page-deck .topbar,
    #page-deck .deck-header,
    #page-deck .hint{
      width: 100% !important;
      max-width: 100% !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      box-sizing: border-box !important;
    }

    /* 4) Екран колоди: мінімум бокових відступів, щоб “розширити” */
    #page-deck .screen{
      padding-left: 8px !important;
      padding-right: 8px !important;
      box-sizing: border-box !important;
      align-items: stretch !important;
    }

    /* 5) Сітка карт на всю ширину */
    #page-deck #deckGrid{
      /* slightly expanded to give extra 5px total width */
      width: calc(100% + 5px) !important;
      max-width: 100% !important;
      margin: 0 !important;
      margin-left: -2.5px !important;
      margin-right: -2.5px !important;
      padding: 0 !important;

      display: grid !important;
      grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
      gap: 6px !important;

      justify-items: stretch !important;
      align-items: stretch !important;
      box-sizing: border-box !important;
    }

    /* 6) Картки розтягуються по колонці */
    #page-deck #deckGrid .sp-card{
      width: 100% !important;
      max-width: 100% !important;
      min-width: 0 !important;
      box-sizing: border-box !important;
    }
  }

  /* Якщо body або .phone все ще центруються в layout — жорсткий оверрайд */
  @media (max-width: 425px) and (orientation: portrait) {
    body{ display: block !important; }
    .phone{ border-radius: 0 !important; }
  }
  </style>
</head>
<body>
  <!-- orientation overlay removed -->

  <!-- Auth overlay -->
  <div class="auth-overlay hidden" id="authOverlay">
    <div class="auth-box">
      <h1 class="auth-title">⚙️ Elem Clone</h1>
      <p class="auth-subtitle">Стімпанк картова гра</p>

      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Вхід</div>
        <div class="auth-tab" data-tab="register">Реєстрація</div>
      </div>

      <!-- Login Form -->
      <form class="auth-form active" id="loginForm">
        <div class="form-group">
          <label class="form-label">Ім'я користувача</label>
          <input type="text" class="form-input" id="loginUsername" placeholder="Введіть ім'я" required>
        </div>
        <button type="submit" class="auth-btn">Увійти</button>
        <div class="auth-error" id="loginError"></div>
      </form>

      <!-- Register Form -->
      <form class="auth-form" id="registerForm">
        <div class="form-group">
          <label class="form-label">Ім'я користувача</label>
          <input type="text" class="form-input" id="registerUsername" placeholder="Введіть ім'я" required minlength="3" maxlength="20">
        </div>
        <button type="submit" class="auth-btn">Зареєструватися</button>
        <div class="auth-error" id="registerError"></div>
      </form>
    </div>
  </div>

  <div class="phone" id="app">
    <div class="noise"></div>

    <header class="topbar">
      <div class="hud">
        <div class="hud-top">
          <div class="toprow">
            <div class="avatar">
              <div class="portrait" aria-hidden="true"></div>
              <div class="level">Рівень: <span>1</span></div>
            </div>

            <div class="meters">
              <div class="meter" title="Болти"><span>🔩</span><strong id="home-bolts">500</strong></div>
              <div class="meter" title="Шестерні"><span>⚙️</span><strong id="home-gears">0</strong></div>
              <div class="meter" title="Парові ядра"><span>✴︎</span><strong id="home-cores">0</strong></div>
            </div>
          </div>

          <!-- legacy statusbar removed -->
        </div>

        <!-- HUD XP row: full-width under the hud-top -->
        <div class="hud-xp-row" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="hud-xp-row__fill" id="xpFill"></div>
          <div class="hud-xp-row__label" id="xpPct">0%</div>
        </div>
      </div>
    </header>

    <!-- Main content container -->
    <div id="main-content">
      <!-- Bag Page -->
      <section class="page" id="page-bag">
        <div class="page-header">
          <button class="back-btn" id="bag-back-btn">← Назад</button>
          <h2 class="page-title">Сумка</h2>
        </div>
        <div class="page-content">
          <div id="bag-cards-list" class="cards-list"></div>
        </div>
      </section>
      
      <!-- Home Page -->
      <section class="page active" id="page-home">
        <section class="tiles" aria-label="Режими">
          <div class="tile" data-page="duels">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">Дуелі</div>
            <div class="sub">Спроби: 10</div>
          </div>

          <div class="tile" data-page="arena">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">Арена</div>
            <div class="sub">Бій</div>
          </div>

          <div class="tile" data-page="deck">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">Бойова колода</div>
            <div class="sub">Сила: <span id="deck-power-home">0</span></div>
          </div>
        </section>

        <section class="list" aria-label="Меню">
          <div class="item" data-page="tasks">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Завдання</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="rewards">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Діамантові нагороди</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="equipment">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Спорядження</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="collections">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Колекції</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="bag">
            <button type="button" id="menu-bag-btn">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Сумка</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="shop">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Магазин</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="buy-gold">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Купити золото</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>
        </section>

        <section class="promo" aria-label="Акція">
          <div class="badge">Акція</div>
          <div class="line">Від 250 до 1250 у подарунок</div>
          <div class="sub">Останній день. Пара та механіка не чекають.</div>
        </section>
      </section>

      <!-- Duels Page -->
      <section class="page" id="page-duels">
        <div class="page-header">
          <button class="back-btn" data-page="home">← Назад</button>
          <h2 class="page-title">Дуелі</h2>
        </div>
        <div class="page-content panel">
          <div class="duel-header">
            <!-- Заголовок убран: автоматический поиск отображается без отдельного названия -->
            <button class="duel-start-btn" id="duel-start-btn">Почати дуель</button>
          </div>
          <div class="duel-hud">
            <div class="duel-hp duel-power"><strong>Сила колод:</strong> <span id="enemyPower">0</span> / <span id="playerPower">0</span></div>
          </div>

          <!-- HUD над рукою ворога: аватар і смуга HP -->
          <div class="enemy-status hud-status">
            <div class="avatar enemy-avatar" id="enemyAvatar">👾</div>
            <div class="hp-wrapper">
              <div class="hp-label"><strong>Ворог:</strong> <span id="enemyHpText">0/0</span></div>
              <div class="hp-bar"><div id="enemyHpBar" class="hp-fill" style="width:0%"></div></div>
            </div>
          </div>

          <!-- Duel grid: 3 columns — enemy row, multipliers row, player row -->
          <div class="duel-grid" id="duelGrid">
            <!-- Enemy slots -->
            <div class="enemy-slot" id="enemySlot0"></div>
            <div class="enemy-slot" id="enemySlot1"></div>
            <div class="enemy-slot" id="enemySlot2"></div>

            <!-- Multiplier slots (will be populated per column) -->
            <div class="mult-slot" id="multSlot0"></div>
            <div class="mult-slot" id="multSlot1"></div>
            <div class="mult-slot" id="multSlot2"></div>

            <!-- Player slots -->
            <div class="player-slot" id="playerSlot0"></div>
            <div class="player-slot" id="playerSlot1"></div>
            <div class="player-slot" id="playerSlot2"></div>
          </div>

          <!-- HUD під рукою гравця: аватар і смуга HP -->
          <div class="player-status hud-status">
            <div class="avatar player-avatar" id="playerAvatar">🙂</div>
            <div class="hp-wrapper">
              <div class="hp-label"><strong>Ви:</strong> <span id="playerHpText">0/0</span></div>
              <div class="hp-bar"><div id="playerHpBar" class="hp-fill" style="width:0%"></div></div>
            </div>
          </div>
          <div class="duel-log" id="duelLog"></div>
        </div>
      </section>

      <!-- Arena Page -->
      <section class="page" id="page-arena">
        <div class="page-header">
          <button class="back-btn" data-page="home">← Назад</button>
          <h2 class="page-title">Арена</h2>
        </div>
        <div class="page-content">
          <div class="info-card">
            <div class="info-label">Поточний ранг</div>
            <div class="info-value">Золото III</div>
          </div>
          <div class="info-card">
            <div class="info-label">Рейтинг</div>
            <div class="info-value">1847</div>
          </div>
          <button class="action-btn">Увійти в арену</button>
          <div class="description">
            Рейтингові бої за ранги. Піднімайтеся вгору за таблицею лідерів і отримуйте ексклюзивні нагороди.
          </div>
        </div>
      </section>

      <!-- Deck Page -->
      <section class="page" id="page-deck">
        <div class="screen">
          
          <!-- Topbar -->
          <header class="topbar">
            <button class="back-btn" data-page="home" style="flex: 0; padding: 6px 10px; font-size: 13px;">← Назад</button>
          </header>

          <!-- Deck Header -->
          <div class="deck-header panel">
            <div class="deck-title">БОЙОВА КОЛОДА</div>
            <div class="deck-power">⚙ <span id="deck-power-value">190</span></div>
          </div>

          <div class="hint panel subtle" id="deck-hint">⬆ Поліпшуйте карти!</div>

          <!-- 3x3 Grid -->
          <section class="deck-grid" id="deckGrid">
            <!-- Карти рендеримо JavaScript -->
          </section>

          <!-- Extras Section -->
          <div class="extras-title">Додаткові карти</div>

          <section class="extras-grid">
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">Союзник</div>
            </div>
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">Гільдія</div>
            </div>
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">Артефакт</div>
            </div>
          </section>

          <div class="link-like">ⓘ Де взяти додаткові карти</div>

          <!-- Menu List -->
          <section class="menu-list panel">
            <button class="menu-row" data-page="duels">⚔ Дуелі</button>
            <button class="menu-row" data-page="arena">🏛 Арена</button>
            <button class="menu-row" data-page="shop">🛍 Магазин</button>
          </section>

        </div>
      </section>

      <!-- Tasks Page -->
      <section class="page" id="page-tasks">
        <div class="page-header">
          <button class="back-btn" data-page="home">← Назад</button>
          <h2 class="page-title">Завдання</h2>
        </div>
        <div class="page-content">
          <div class="task-item">
            <div class="task-text">Виграйте 3 дуелі</div>
            <div class="task-progress">1/3</div>
            <div class="task-reward">+50 XP, 5 золота</div>
          </div>
          <div class="task-item completed">
            <div class="task-text">Увійдіть у гру</div>
            <div class="task-progress">✓</div>
            <div class="task-reward">+10 XP</div>
          </div>
          <div class="task-item">
            <div class="task-text">Зберіть 100 кристалів</div>
            <div class="task-progress">67/100</div>
            <div class="task-reward">+100 XP, 20 золота</div>
          </div>
        </div>
      </section>

      <!-- Rewards Page -->
      <section class="page" id="page-rewards">
        <div class="page-header">
          <button class="back-btn" data-page="home">← Назад</button>
          <h2 class="page-title">Діамантові нагороди</h2>
        </div>
        <div class="page-content">
          <div class="reward-item available">
            <div class="reward-icon">💎</div>
            <div class="reward-text">Щоденна нагорода</div>
            <button class="claim-btn">Отримати</button>
          </div>
          <div class="reward-item locked">
            <div class="reward-icon">🏆</div>
            <div class="reward-text">Досягнення: 10 перемог</div>
            <div class="reward-progress">8/10</div>
          </div>
          <div class="reward-item locked">
            <div class="reward-icon">⭐</div>
            <div class="reward-text">Рангова нагорода</div>
            <div class="reward-progress">Срібло II потрібно</div>
          </div>
        </div>
      </section>

      <!-- Equipment Page -->
      <section class="page" id="page-equipment">
        <div class="page-header">
          <button class="back-btn" data-page="home">← Назад</button>
          <h2 class="page-title">Спорядження</h2>
        </div>
        <div class="page-content">
          <div class="equipment-slot">
            <div class="slot-name">Манометр</div>
            <div class="slot-item equipped">Паровий датчик +5</div>
            <div class="slot-bonus">+5% до атаки</div>
          </div>
          <div class="equipment-slot">
            <div class="slot-name">Котушка Тесли</div>
            <div class="slot-item">Порожньо</div>
          </div>
          <div class="equipment-slot">
            <div class="slot-name">Мідна руна</div>
            <div class="slot-item equipped">Руна захисту</div>
            <div class="slot-bonus">+3% до захисту</div>
          </div>
        </div>
      </section>

      <!-- Collections Page -->
      <section class="page" id="page-collections">
        <div class="page-header">
          <button class="back-btn" data-page="home">← Назад</button>
          <h2 class="page-title">Колекції</h2>
        </div>
        <div class="page-content">
          <div class="collection-set">
            <div class="collection-set" id="fire-set">
              <div class="set-name">Вогняна стихія</div>
              <div class="set-progress" id="fire-progress">0/4 карт</div>
              <div class="set-bonus">+10% до вогняної шкоди</div>
              <div class="collection-grid" id="fire-collection"></div>
            </div>
            <div class="collection-set" id="water-set">
              <div class="set-name">Водяна стихія</div>
              <div class="set-progress" id="water-progress">0/4 карт</div>
              <div class="set-bonus">+10% до водяної шкоди</div>
              <div class="collection-grid" id="water-collection"></div>
            </div>
            <div class="collection-set" id="air-set">
              <div class="set-name">Повітряна стихія</div>
              <div class="set-progress" id="air-progress">0/4 карт</div>
              <div class="set-bonus">+10% до повітряної шкоди</div>
              <div class="collection-grid" id="air-collection"></div>
            </div>
            <div class="collection-set" id="earth-set">
              <div class="set-name">Земляна стихія</div>
              <div class="set-progress" id="earth-progress">0/4 карт</div>
              <div class="set-bonus">+10% до земляної шкоди</div>
              <div class="collection-grid" id="earth-collection"></div>
            </div>
        </div>
      </section>

      <!-- Card Details Page -->
      <section class="page" id="page-card-details">
        <div class="page-header">
          <button class="back-btn" id="card-details-back">← Назад</button>
          <h2 class="page-title">Деталі карти</h2>
        </div>
        <div class="page-content">
          <!-- Main Card Display -->
          <div class="card-main-display panel" id="card-main-info">
            <!-- Рендеримо через JavaScript -->
          </div>

          <!-- Card Upgrade Scale (нова система XP) -->
          <div class="card-upgrade" id="card-upgrade-section">
            <div class="upgrade-header">
              <span id="cu-level">LV 1</span>
              <span id="cu-xp-text">0 / 20 XP</span>
            </div>
            <div class="xp-bar">
              <div class="xp-fill" id="cu-xp-fill"></div>
            </div>
            
          </div>

          <!-- Comparison Section -->
          <div class="card-comparison">
            <h3 class="comparison-title" id="weaker-cards-header">📊 Слабші карти тієї ж стихії</h3>
            <div id="weaker-cards-list" class="weaker-cards">
              <!-- Список слабших карт -->
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card-actions">
            
            <button id="card-add-to-deck-btn" class="action-btn add-btn">Додати в колоду</button>
            <button id="card-remove-btn" class="action-btn remove-btn">Видалити</button>
          </div>
        </div>
      </section>

      <!-- Shop Page -->
      <section class="page" id="page-shop">
        <div class="page-header">
          <button class="back-btn" data-page="home">← Назад</button>
          <h2 class="page-title">Магічні Карти</h2>
        </div>
        <div class="page-content">
          
          <!-- Special Offers Section -->
          <div class="shop-section">
            <div class="shop-section-title">⭐ Набори по акції!</div>
            <div class="shop-notice">
              Купуйте набори по спеціальній ціні! Доступно тільки раз!
            </div>
            <div id="offers-container">
              <!-- Special offers will be rendered here -->
            </div>
          </div>

          <!-- Single Cards Section -->
          <div class="shop-section">
            <div class="shop-section-title">🃏 По одній карті</div>
            <div id="single-cards-container">
              <!-- Single card offers will be rendered here -->
            </div>
          </div>

        </div>
      </section>

      <!-- Pack Opening Modal -->
      <div class="pack-modal" id="pack-modal">
        <div class="pack-modal-content">
          <div class="pack-modal-header">
            <div class="pack-modal-title">Ви отримали:</div>
            <div class="pack-modal-subtitle">Карти додано в колекцію</div>
          </div>
          <div class="pack-rewards" id="pack-rewards">
            <!-- Rewards will be rendered here -->
          </div>
          <button class="pack-modal-btn" id="pack-modal-close">Прийняти</button>
        </div>
      </div>

      <!-- Duel Result Modal -->
      <div class="pack-modal" id="duel-result-modal">
        <div class="pack-modal-content">
          <div class="pack-modal-header">
            <div class="pack-modal-title" id="duel-result-title">Перемога!</div>
            <div class="pack-modal-subtitle" id="duel-result-subtitle">Ви отримали:</div>
          </div>
          <div class="duel-result-rewards" id="duel-result-rewards">
            <!-- Rewards displayed here -->
          </div>
          <div class="duel-result-stats-info">
            <div class="duel-wins-info" id="duel-wins-info">Побід в дуелях: 🏆 0</div>
          </div>
          <button class="pack-modal-btn duel-next-btn" id="duel-result-close">Ще дуель</button>
          <div class="duel-battle-summary">
            <div class="duel-summary-title">Підсумки бою</div>
            <div class="duel-summary-hp">
              <span>♥ <span id="duel-summary-player-hp">0</span></span>
            </div>
            <div class="duel-battle-cards" id="duel-battle-cards">
              <!-- Battle cards summary -->
            </div>
          </div>
        </div>
      </div>

      <!-- Pre-duel modal -->
      <div class="pack-modal" id="duel-pre-modal">
        <div class="pack-modal-content" style="max-width:460px; text-align:center;">
          <div class="pack-modal-header">
            <div class="pack-modal-title">Знайдено суперника</div>
            <div class="pack-modal-subtitle">Перевір силу колод і натисни «Напасти»</div>
          </div>
          <div class="preduel-body">
            <div class="preduel-row">
              <div class="preduel-label">Суперник</div>
              <div class="preduel-value" id="duel-pre-name">—</div>
            </div>
            <div class="preduel-row">
              <div class="preduel-label">Сила ворога</div>
              <div class="preduel-value" id="duel-pre-power">0</div>
            </div>
            <div class="preduel-row">
              <div class="preduel-label">Твоя сила</div>
              <div class="preduel-value" id="duel-pre-player-power">0</div>
            </div>
          </div>
          <div class="preduel-actions">
            <button class="pack-modal-btn" id="duel-pre-attack">Напасти</button>
            <button class="pack-modal-btn secondary" id="duel-pre-reroll">Шукати ще</button>
          </div>
        </div>
      </div>

      <!-- Buy Gold Page -->
      <section class="page" id="page-buy-gold">
        <div class="page-header">
          <button class="back-btn" data-page="home">← Назад</button>
          <h2 class="page-title">Купити золото</h2>
        </div>
        <div class="page-content">
          <div class="gold-pack">
            <div class="pack-amount">100 золота</div>
            <div class="pack-price">50 кристалів</div>
            <button class="exchange-btn">Обміняти</button>
          </div>
          <div class="gold-pack featured">
            <div class="pack-badge">Акція</div>
            <div class="pack-amount">500 золота</div>
            <div class="pack-price">200 кристалів</div>
            <div class="pack-bonus">+50 бонус</div>
            <button class="exchange-btn">Обміняти</button>
          </div>
          <div class="gold-pack">
            <div class="pack-amount">1000 золота</div>
            <div class="pack-price">350 кристалів</div>
            <button class="exchange-btn">Обміняти</button>
          </div>
        </div>
      </section>

      <!-- Profile Page -->
      <section class="page" id="page-profile">
        <div class="page-header">
          <h2 class="page-title">Профіль</h2>
        </div>
        <div class="page-content">
          <div class="profile-stat">
            <div class="stat-label">Рівень</div>
            <div class="stat-value" id="profile-level">1</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">Досвід</div>
            <div class="stat-value" id="profile-xp">0/100</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">Перемог</div>
            <div class="stat-value" id="profile-wins">0</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">Поразок</div>
            <div class="stat-value" id="profile-losses">0</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">Ігор зіграно</div>
            <div class="stat-value" id="profile-games">0</div>
          </div>
          <button class="action-btn logout-btn">Вийти з акаунту</button>
        </div>
      </section>

      <!-- Guild Page -->
      <section class="page" id="page-guild">
        <div class="page-header">
          <h2 class="page-title">Гільдія</h2>
        </div>
        <div class="page-content">
          <div class="guild-status">
            <div class="status-text">Ви не в гільдії</div>
          </div>
          <button class="action-btn">Створити гільдію</button>
          <button class="action-btn secondary">Знайти гільдію</button>
          <div class="description">
            Приєднайтеся до гільдії, щоб співпрацювати з іншими гравцями, брати участь у гільдійських подіях та отримувати особливі бонуси.
          </div>
        </div>
      </section>

    </div>

    <nav class="bottom" aria-label="Навігація">
      <div class="navbtn active" id="nav-home" data-tab="home">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">Головна</div>
      </div>
      <div class="navbtn" id="nav-profile" data-tab="profile">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">Профіль</div>
      </div>
      <div class="navbtn" id="nav-guild" data-tab="guild">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">Гільдія</div>
      </div>
    </nav>
  </div>

  <!-- Card System Scripts -->
  <script src="js/data/cards.js"></script>
  <script src="js/game/power.js"></script>
  <script src="js/game/drop.js"></script>
  <script src="js/data/cards_index.js"></script>
  <script src="js/game/currencies.js"></script>
  <script src="card-renderer.js"></script>
  <!-- Duel Engine Scripts -->
  <script src="js/game/elements.js"></script>

  <script src="js/game/duel_runtime.js"></script>
  <!-- CardView global for modal rendering -->
  <script src="js/ui/components/CardView.global.js"></script>

  <script>
    // Initialize CardRenderer
    window.addEventListener('DOMContentLoaded', () => {
      window.cardRenderer = new CardRenderer();
      console.log('CardRenderer initialized');
    });
    
    // Делегований паралакс ефект для всіх карт
    function initCardParallax() {
      document.addEventListener('mousemove', (e) => {
        const card = e.target.closest('.sp-card');
        if (!card) return;
        
        // Не застосовуємо трансформацію на карту, якщо вона не в :hover
        // це запобігає конфліктам з позиціюванням дітей
        if (!card.matches(':hover')) {
          return;
        }

        const rect = card.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        const x = (e.clientX - centerX) / 50;
        const y = (e.clientY - centerY) / 50;

        // Застосовуємо тільки базові трансформації, які не конфліктують з дітьми
        card.style.transform = `perspective(1000px) rotateX(${5 - y}deg) rotateY(${-2 + x}deg)`;
      });

      // Скидання трансформації при виході
      document.addEventListener('mouseleave', (e) => {
        const card = e.target.closest?.('.sp-card');
        if (card) {
          card.style.transform = '';
        }
      }, true);
    }
    
    // Ініціалізуємо паралакс після DOMContentLoaded
    window.addEventListener('DOMContentLoaded', () => {
      initCardParallax();
    });

    // LocalStorage management
    const storage = {
      get(key, defaultValue = null) {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : defaultValue;
        } catch (error) {
          console.error(`Error reading localStorage (${key}):`, error);
          return defaultValue;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (error) {
          console.error(`Error writing localStorage (${key}):`, error);
          return false;
        }
      }
    };

    // User profile management
    const userProfile = {
      STORAGE_KEY: 'elem_user_profile',
      USERS_KEY: 'elem_users',
      
      // Get all registered users
      getAllUsers() {
        return storage.get(this.USERS_KEY, {});
      },
      
      // Save all users
      saveAllUsers(users) {
        return storage.set(this.USERS_KEY, users);
      },
      
      // Check if username exists
      userExists(username) {
        const users = this.getAllUsers();
        return users.hasOwnProperty(username);
      },
      
      // Register new user
      registerUser(username) {
        if (this.userExists(username)) {
          return { success: false, error: 'Це ім\'я вже зайняте' };
        }
        
        if (username.length < 3) {
          return { success: false, error: 'Ім\'я має бути не менше 3 символів' };
        }
        
        // Generate random 16 starter cards (4 per element)
        const starterIds = (window.getRandomStarterCardIds && window.getRandomStarterCardIds(16))
          || (window.getStarterCardIds && window.getStarterCardIds())
          || [];

        // Fallback to any cards if starters unavailable
        const pool = starterIds.length ? starterIds : (window.ALL_CARDS || []).map(c => c.id);

        // Shuffle ids
        const shuffled = [...pool];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        const selectedIds = shuffled.slice(0, 16);
        const selectedCards = selectedIds
          .map(id => (window.getCardById ? window.getCardById(id) : null))
          .filter(Boolean);
        
        // First 9 go to deck, rest go to collection
        const deckCards = selectedCards.slice(0, 9).map(card => ({
          id: card.id,
          level: 1
        }));
        const collectionCards = selectedCards.slice(9, 16).map(card => ({
          id: card.id,
          level: 1
        }));
        
        // Initialize progress (XP) for each card
        const progress = {};
        selectedCards.forEach(card => {
          progress[card.id] = { level: 1, xp: 0 };
        });
        
        // Initialize inventory: count of each card
        const inventory = {};
        selectedCards.forEach(card => {
          inventory[card.id] = (inventory[card.id] || 0) + 1;
        });
        
        const users = this.getAllUsers();
        users[username] = {
          name: username,
          level: 1,
          xp: 0,
          bolts: 500,         // Болти 🔩 (базова валюта)
          gears: 0,           // Шестерні ⚙️ (середня валюта)
          cores: 0,           // Парові ядра ✴︎ (преміум валюта)
          wins: 0,
          losses: 0,
          gamesPlayed: 0,
          createdAt: Date.now(),
          deckCards: deckCards,
          collectionCards: collectionCards,
          progress: progress,    // XP для кожної карти
          inventory: inventory   // кількість копій
        };
        
        this.saveAllUsers(users);
        return { success: true, profile: users[username] };
      },
      
      // Login user
      loginUser(username) {
        if (!this.userExists(username)) {
          return { success: false, error: 'Користувача не знайдено' };
        }
        
        const users = this.getAllUsers();
        const profile = users[username];
        storage.set(this.STORAGE_KEY, profile);
        return { success: true, profile: profile };
      },
      
      // Get current logged in profile
      getCurrentUser() {
        return storage.get(this.STORAGE_KEY);
      },
      
      // Check if user is logged in
      isLoggedIn() {
        return this.getCurrentUser() !== null;
      },
      
      // Logout
      logout() {
        storage.set('currentUser', null);
        localStorage.removeItem(this.STORAGE_KEY);
      },
      
      // Update current user profile
      updateCurrentUser(updates) {
        const profile = this.getCurrentUser();
        if (!profile) return false;
        
        Object.assign(profile, updates);
        storage.set(this.STORAGE_KEY, profile);
        
        // Also update in users list
        const users = this.getAllUsers();
        if (users[profile.name]) {
          users[profile.name] = profile;
          this.saveAllUsers(users);
        }
        
        return profile;
      },
      
      getProfile() {
        return this.getCurrentUser();
      },
      
      saveProfile(profile) {
        return this.updateCurrentUser(profile);
      },

      autoAddToDeck(profile, cardEntry) {
        if (!profile || !cardEntry) {
          return { added: false, replaced: false, replacedPower: null };
        }

        if (!profile.deckCards) profile.deckCards = [];

        const cardObj = window.getCardById && window.getCardById(cardEntry.id);
        const cardPower = window.getPower
          ? window.getPower(cardObj, cardEntry.level || 1)
          : (cardObj ? cardObj.basePower : 0);

        if (profile.deckCards.length < 9) {
          profile.deckCards.push(cardEntry);
          return { added: true, replaced: false, replacedPower: null };
        }

        let weakestIdx = -1;
        let weakestPower = Infinity;

        profile.deckCards.forEach((dc, idx) => {
          const dcObj = window.getCardById && window.getCardById(dc.id);
          const pwr = window.getPower
            ? window.getPower(dcObj, dc.level || 1)
            : (dcObj ? dcObj.basePower : 0);

          if (pwr < weakestPower) {
            weakestPower = pwr;
            weakestIdx = idx;
          }
        });

        if (weakestIdx >= 0 && cardPower > weakestPower) {
          profile.deckCards[weakestIdx] = cardEntry;
          return { added: false, replaced: true, replacedPower: weakestPower };
        }

        return { added: false, replaced: false, replacedPower: weakestPower };
      },
      
      updateUI() {
        const profile = this.getCurrentUser();
        if (!profile) return;
        
        // Update level
        const levelSpan = document.querySelector('.level span');
        if (levelSpan) {
          levelSpan.textContent = profile.level;
        }
        
        // Update currencies on HOME PAGE
        const homeBolts = document.getElementById('home-bolts');
        const homeGears = document.getElementById('home-gears');
        const homeCores = document.getElementById('home-cores');
        
        if (homeBolts) homeBolts.textContent = profile.bolts || 0;
        if (homeGears) homeGears.textContent = profile.gears || 0;
        if (homeCores) homeCores.textContent = profile.cores || 0;
        
        // Update currencies on DECK PAGE
        const boltVal = document.getElementById('deck-bolts');
        const gearVal = document.getElementById('deck-gears');
        const coreVal = document.getElementById('deck-cores');
        
        if (boltVal) boltVal.textContent = profile.bolts || 0;
        if (gearVal) gearVal.textContent = profile.gears || 0;
        if (coreVal) coreVal.textContent = profile.cores || 0;
        
        // Update HUD-wide XP bar
        const hudXpFill = document.getElementById('xpFill');
        const hudXpPct = document.getElementById('xpPct');
        const hudBar = document.querySelector('.hud-xp-row');

        const need = navigation.xpNeededForLevel(profile.level || 1) || 100;
        const curXp = profile.xp || 0;
        const pct = need > 0 ? Math.max(0, Math.min(1, curXp / need)) : 0;
        const xpPercent = Math.round(pct * 100);

        // legacy references removed

        if (hudXpPct) hudXpPct.textContent = `${xpPercent}% (${curXp}/${need})`;
        if (hudBar) {
          hudBar.setAttribute('aria-valuemax', String(need));
          hudBar.setAttribute('aria-valuenow', String(curXp));
          hudBar.setAttribute('aria-valuetext', `${xpPercent}% (${curXp}/${need})`);
        }
        if (hudXpFill) hudXpFill.style.transform = `scaleX(${pct})`;
        
        // Update deck power on home screen (use actual progress levels)
        if (profile.deckCards && profile.deckCards.length > 0) {
          let totalPower = 0;
          profile.deckCards.forEach(dc => {
            const card = window.getCardById && window.getCardById(dc.id);
            if (card) {
              const prog = window.getProgress ? window.getProgress(profile, dc.id) : { level: dc.level || 1, xp: 0 };
              const level = (prog && prog.level) ? prog.level : (dc.level || 1);
              const power = window.getPower ? window.getPower(card, level) : (typeof getPower === 'function' ? getPower(card, level) : 0);
              totalPower += power || 0;
            }
          });
          const deckPowerHome = document.getElementById('deck-power-home');
          if (deckPowerHome) {
            deckPowerHome.textContent = totalPower;
          }
        }
        
        // Update username in portrait
        const portrait = document.querySelector('.portrait');
        if (portrait) {
          portrait.title = profile.name;
        }
      }
    };

    // Auth UI management
    const authUI = {
      overlay: null,
      
      init() {
        this.overlay = document.getElementById('authOverlay');
        
        // Tab switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            this.switchTab(tabName);
          });
        });
        
        // Login form
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });
        
        // Register form
        document.getElementById('registerForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleRegister();
        });
        
        // Check if already logged in
        if (userProfile.isLoggedIn()) {
          this.hideAuth();
        } else {
          this.showAuth();
        }
      },
      
      switchTab(tabName) {
        // Update tabs
        document.querySelectorAll('.auth-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.tab === tabName);
        });
        
        // Update forms
        document.querySelectorAll('.auth-form').forEach(f => {
          f.classList.toggle('active', f.id === tabName + 'Form');
        });
        
        // Clear errors
        this.hideError('login');
        this.hideError('register');
      },
      
      handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        
        if (!username) {
          this.showError('login', 'Введіть ім\'я користувача');
          return;
        }
        
        const result = userProfile.loginUser(username);
        
        if (result.success) {
          console.log('Login successful:', result.profile);
          this.hideAuth();
          userProfile.updateUI();
        } else {
          this.showError('login', result.error);
        }
      },
      
      handleRegister() {
        const username = document.getElementById('registerUsername').value.trim();
        
        if (!username) {
          this.showError('register', 'Введіть ім\'я користувача');
          return;
        }
        
        const result = userProfile.registerUser(username);
        
        if (result.success) {
          console.log('Registration successful:', result.profile);
          // Auto-login after registration
          userProfile.loginUser(username);
          this.hideAuth();
          userProfile.updateUI();
        } else {
          this.showError('register', result.error);
        }
      },
      
      showError(formType, message) {
        const errorEl = document.getElementById(formType + 'Error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.add('show');
        }
      },
      
      hideError(formType) {
        const errorEl = document.getElementById(formType + 'Error');
        if (errorEl) {
          errorEl.classList.remove('show');
        }
      },
      
      showAuth() {
        if (this.overlay) {
          this.overlay.style.display = 'flex';
          setTimeout(() => {
            this.overlay.classList.remove('hidden');
          }, 10);
        }
      },
      
      hideAuth() {
        if (this.overlay) {
          this.overlay.classList.add('hidden');
        }
      }
    };

    // Page navigation system
    const navigation = {
        // ========== BAG SYSTEM ========== 
        loadBagCards() {
          const profile = userProfile.getProfile();
          if (!profile) return;
          // В сумці — лише ті карти з collectionCards, яких немає в deckCards
          let deckIds = new Set((profile.deckCards || []).map(c => c.id));
          const bagCards = (profile.collectionCards || []).filter(c => !deckIds.has(c.id));
          const container = document.getElementById('bag-cards-list');
          if (!container) return;
          if (bagCards.length === 0) {
            container.innerHTML = '<div class="no-bag-cards">Немає карт у сумці</div>';
            return;
          }
          const elementEmojis = {
            fire: '🔥',
            water: '💧',
            air: '♨️',
            earth: '🍃'
          };
          container.innerHTML = bagCards.map(card => {
            const cardData = getCardById(card.id);
            if (!cardData) return '';
            const emoji = elementEmojis[cardData.element] || '⚙';
            return `
              <div class="bag-card-item" data-card-id="${card.id}">
                <span class="bag-card-emoji">${emoji}</span>
                <span class="bag-card-name">${cardData.name}</span>
                <span class="bag-card-status">Знайдено</span>
              </div>
            `;
          }).join('');
        },
        // ========== END BAG SYSTEM ========== 
          // Отримати карти з сумки (які не в колоді)
          getBagCards(profile) {
            if (!profile) return [];
            let deckIds = new Set((profile.deckCards || []).map(c => c.id));
            // Повертаємо тільки ті карти з collectionCards, яких немає в deckCards
            return (profile.collectionCards || []).filter(c => !deckIds.has(c.id));
          },
      currentPage: 'home',
      
      showPage(pageId) {
        // Remove active class from all pages
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        // Add active class to target page
        const targetPage = document.getElementById(`page-${pageId}`);
        if (targetPage) {
          targetPage.classList.add('active');
          this.currentPage = pageId;
          
          // Update profile stats if on profile page
          if (pageId === 'profile') {
            this.updateProfilePage();
          }
          
          // Load deck cards if on deck page
          if (pageId === 'deck') {
            this.loadDeckCards();
          }
          
          // Load collection cards if on collections page
          if (pageId === 'collections') {
            this.loadCollectionCards();
          }
          
          // Load shop if on shop page
          if (pageId === 'shop') {
            this.loadShop();
          }

          // Initialize duels UI
          if (pageId === 'duels') {
            this.initDuelsPage();
          }
        }
      },
      
      updateProfilePage() {
        const profile = userProfile.getProfile();
        const lvl = profile.level || 1;
        const need = this.xpNeededForLevel(lvl);
        document.getElementById('profile-level').textContent = String(lvl);
        document.getElementById('profile-xp').textContent = `${profile.xp || 0}/${need}`;
        document.getElementById('profile-wins').textContent = profile.wins;
        document.getElementById('profile-losses').textContent = profile.losses;
        document.getElementById('profile-games').textContent = profile.gamesPlayed;
      },

      // ========== UPGRADE SYSTEM ==========
      
      // Build inventory from deck + collection
      getInventory(profile) {
        const inventory = {};
        
        // Count cards from both deck and collection
        [...profile.deckCards, ...profile.collectionCards].forEach(userCard => {
          inventory[userCard.id] = (inventory[userCard.id] || 0) + 1;
        });
        
        return inventory;
      },

      // Get count of extra copies available for upgrade
      getExtraCopies(inventory, cardId) {
        const total = inventory[cardId] || 0;
        return Math.max(0, total - 1); // -1 because one copy is in deck
      },

      // Get cost to upgrade from current level to next
      getUpgradeCost(level) {
        return level; // lvl 1->2 costs 1, lvl 2->3 costs 2, etc
      },

      // Check if a deck card can be upgraded
      canUpgradeCard(deckItem, inventory) {
        const cost = this.getUpgradeCost(deckItem.level);
        const extra = this.getExtraCopies(inventory, deckItem.id);
        return extra >= cost;
      },

      // Check if deck has any upgradable cards
      hasAnyUpgradable(deck, inventory) {
        return deck.some(item => this.canUpgradeCard(item, inventory));
      },

      // Check if a target card can be guaranteed to level up by burning owned weaker cards
      canGuaranteedLevelByBurning(profile, targetCardId) {
        if (!profile || !targetCardId) return false;
        // get current progress
          const prog = window.getProgress ? window.getProgress(profile, targetCardId) : (profile.progress && profile.progress[targetCardId]) || { level: 1, xp: 0 };
        const need = window.xpNeed ? window.xpNeed(prog.level) : this.xpNeededForLevel(prog.level);
        const remaining = Math.max(0, need - (prog.xp || 0));
        if (remaining <= 0) return true;

        const targetCard = window.getCardById ? window.getCardById(targetCardId) : null;
        if (!targetCard) return false;

          const deckIds = new Set((profile.deckCards || []).map(d => d.id));
          // If target card is in deck, never show guarantee indicator
          if (deckIds.has(targetCardId)) return false;

        // Sum available XP from collection entries (excluding deck copies)
        let totalXp = 0;
        if (Array.isArray(profile.collectionCards)) {
          for (let i = 0; i < profile.collectionCards.length; i++) {
            const entry = profile.collectionCards[i];
            if (!entry || !entry.id) continue;
            if (entry.id === targetCardId) continue;
            if (deckIds.has(entry.id)) continue;
            const c = window.getCardById ? window.getCardById(entry.id) : null;
            if (!c || c.element !== targetCard.element) continue;
            const lvl = entry.level || 1;
            const gain = window.xpValue ? window.xpValue(lvl) : (c.basePower || 10);
            totalXp += gain;
            if (totalXp >= remaining) return true;
          }
        }

        // Sum available XP from inventory counters (assume level 1 for inventory entries)
        const inv = profile.inventory || {};
        for (const id in inv) {
          if (!Object.prototype.hasOwnProperty.call(inv, id)) continue;
          const count = inv[id] || 0;
          if (count <= 0) continue;
          if (id === targetCardId) continue;
          if (deckIds.has(id)) continue;
          const c = window.getCardById ? window.getCardById(id) : null;
          if (!c || c.element !== targetCard.element) continue;
          const gain = window.xpValue ? window.xpValue(1) : (c.basePower || 10);
          totalXp += gain * count;
          if (totalXp >= remaining) return true;
        }

        return false;
      },

      // Perform upgrade on a deck card
      performUpgrade(deckItem, inventory, profile) {
        const cost = this.getUpgradeCost(deckItem.level);
        const extra = this.getExtraCopies(inventory, deckItem.id);

        if (extra < cost) return false;

        // Remove used copies from collection
        let toRemove = cost;
        for (let i = profile.collectionCards.length - 1; i >= 0 && toRemove > 0; i--) {
          if (profile.collectionCards[i].id === deckItem.id) {
            profile.collectionCards.splice(i, 1);
            toRemove--;
          }
        }

        // Increase level
        deckItem.level += 1;

        // Save profile
        userProfile.updateCurrentUser(profile);

        return true;
      },

      // ========== END UPGRADE SYSTEM ==========

      // ========== SHOP SYSTEM ==========
      
      // Shop products catalog
      getShopProducts() {
        return {
          offers: [
            {
              sku: 'offer_elements',
              title: 'Колекція елементалів',
              description: 'Всі чотири карти з колекції «Елементалі»',
              icon: '🔥',
              price: { currency: 'gears', amount: 20 },
              contents: { cards: 4 },
              limited: true
            }
          ],
          packs: [],
          singleCards: [
            {
              sku: 'card_legendary',
              title: 'Легендарна карта',
              description: 'Гарантована легендарна карта',
              icon: '⚡',
              price: { currency: 'gears', amount: 150 },
              contents: { cards: 1 },
              chance: { text: '40% шанс міфічної', class: '' }
            },
            {
              sku: 'card_epic',
              title: 'Епічна карта',
              description: 'Гарантована епічна карта',
              icon: '💜',
              price: { currency: 'gears', amount: 50 },
              contents: { cards: 1 },
              chance: { text: '30% шанс міфічної', class: 'rare' }
            },
            {
              sku: 'card_uncommon',
              title: 'Незвичайна карта',
              description: 'Гарантована незвичайна карта',
              icon: '💚',
              price: { currency: 'bolts', amount: 500 },
              contents: { cards: 1 },
              chance: { text: '15% шанс епічної', class: 'uncommon' }
            }
          ]
        };
      },

      loadShop() {
        const products = this.getShopProducts();
        this.renderNewShopItems('offers-container', products.offers, true);
        this.renderNewShopItems('single-cards-container', products.singleCards, false, true);
      },

      renderNewShopItems(containerId, items, isLimited = false, hasChance = false) {
        const container = document.getElementById(containerId);
        if (!container) {
          console.warn(`Container not found: ${containerId}`);
          return;
        }

        const profile = userProfile.getProfile();
        container.innerHTML = '';

        console.log(`Rendering ${items.length} items to ${containerId}`);

        items.forEach(item => {
          // Check if this is a one-time purchase that was already bought
          if (item.sku === 'offer_elements' && profile && profile.purchasedOffers && profile.purchasedOffers.includes('offer_elements')) {
            console.log(`Skipping already purchased: ${item.sku}`);
            return; // Skip rendering this item
          }

          const card = document.createElement('div');
          card.className = 'shop-item-card';

          const currencyEmojis = {
            bolts: '🔩',
            gears: '⚙️',
            cores: '✴︎'
          };
          const currencyIcon = currencyEmojis[item.price.currency] || '?';
          
          const chanceHTML = hasChance && item.chance 
            ? `<div class="shop-item-chance ${item.chance.class}">${item.chance.text}</div>`
            : '';

          card.innerHTML = `
            <div class="shop-item-icon">${item.icon}</div>
            <div class="shop-item-content">
              <div class="shop-item-name">${item.title}</div>
              <div class="shop-item-desc">${item.description}</div>
              ${chanceHTML}
            </div>
            <div class="shop-item-action">
              <div class="shop-item-price">${currencyIcon} ${item.price.amount}</div>
              <button class="shop-buy-button" data-sku="${item.sku}">
                Купити
              </button>
            </div>
          `;

          container.appendChild(card);
        });

        // Add click handlers
        container.querySelectorAll('.shop-buy-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const sku = btn.dataset.sku;
            console.log('Buying product:', sku);
            navigation.buyProduct(sku);
          });
        });
      },

      loadShopCards(elementFilter = 'all') {
        const profile = userProfile.getProfile();
        if (!profile) return;

        const container = document.getElementById('cards-container');
        if (!container) return;

        container.innerHTML = '';

        // Get all cards
        let allCards = window.ALL_CARDS || [];
        
        // Filter by element
        const filteredCards = elementFilter === 'all' 
          ? allCards 
          : allCards.filter(c => c.element === elementFilter);

        // Display cards with prices (prefer deck renderer to ensure identical visuals)
        filteredCards.forEach(card => {
          const cardDiv = document.createElement('div');
          cardDiv.className = 'product-card';

          const displayPower = window.getPower ? window.getPower(card, 1) : (card.basePower || card.power || 0);
          // Price based on rarity/power
          const prices = {
            gears: Math.max(1, Math.ceil(displayPower * 2)),
            bolts: Math.max(1, Math.ceil(displayPower / 1.5)),
            cores: Math.max(1, Math.ceil(displayPower / 3))
          };

          // Render visual: prefer the site's deck renderer so shop cards match deck visuals
          let visualHtml = '';
          try {
            if (typeof this.renderDeckCard === 'function') {
              visualHtml = this.renderDeckCard(card, 1);
            }
          } catch (err) {
            console.warn('renderDeckCard failed for shop card', card.id, err);
            visualHtml = '';
          }

          if (!visualHtml && window.cardRenderer && typeof window.cardRenderer.render === 'function') {
            try {
              visualHtml = window.cardRenderer.render({ ...card, power: displayPower });
            } catch (err) {
              console.warn('cardRenderer.render failed for shop card', card.id, err);
              visualHtml = '';
            }
          }

          if (!visualHtml && window.createCardView) {
            try {
              const el = window.createCardView(card);
              visualHtml = el ? el.outerHTML : '';
            } catch (err) {
              console.warn('createCardView failed for shop card', card.id, err);
            }
          }

          if (!visualHtml) {
            const elementEmoji = this.getElementEmoji(card.element);
            visualHtml = `<div class="product-icon">${elementEmoji}</div>`;
          } else {
            // wrap visual into container matching product-icon slot and mark as mini
            visualHtml = `<div class="product-icon product-mini">${visualHtml}</div>`;
          }

          cardDiv.innerHTML = `
            <div class="product-header">
              ${visualHtml}
              <div class="product-info">
                <div class="product-title">${card.name}</div>
                <div class="product-desc">Сила: ${displayPower}</div>
              </div>
            </div>
            <div class="product-footer">
              <div style="display: flex; gap: 8px; flex-direction: column; width: 100%;">
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="gears" data-price="${prices.gears}" title="Шестерні">
                  🔧 ${prices.gears}
                </button>
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="bolts" data-price="${prices.bolts}" title="Болти">
                  ⚙️ ${prices.bolts}
                </button>
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="cores" data-price="${prices.cores}" title="Парові ядра">
                  🔥 ${prices.cores}
                </button>
              </div>
            </div>
          `;

          container.appendChild(cardDiv);
        });

        // Add click handlers for card purchase
        container.querySelectorAll('.product-buy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const cardId = btn.dataset.cardId;
            const currency = btn.dataset.currency;
            const price = parseInt(btn.dataset.price);
            this.buyCard(cardId, currency, price);
          });
        });
      },

      buyCard(cardId, currency, price) {
        const profile = this.getProfile();
        if (!profile) return;

        // Check balance using Currency System
        if (!window.CurrencySystem.canAfford(profile, currency, price)) {
          const currencyName = window.CurrencySystem.getCurrencyNameGenitive(currency);
          alert(`Недостатньо ${currencyName}! Потрібно ${price}`);
          return;
        }

        const card = window.getCardById(cardId);
        if (!card) return;

        // Deduct currency using Currency System
        window.CurrencySystem.deduct(profile, currency, price);

        // Add card to collection
        if (!profile.collectionCards) {
          profile.collectionCards = [];
        }
        const newCardEntry = { id: card.id, level: 1 };
        profile.collectionCards.push(newCardEntry);

        // Авто-додавання в колоду: якщо менше 9 карт – додаємо;
        // інакше замінюємо найслабшу карту, якщо нова сильніша
        userProfile.autoAddToDeck(profile, newCardEntry);

        // Додати в inventory (для прокачки)
        if (!profile.inventory) {
          profile.inventory = {};
        }
        profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;

        // Ініціалізувати прогрес карти
        const prog = window.getProgress ? window.getProgress(profile, card.id) : null;

        // Save profile (includes collection + deck changes)
        this.saveProfile(profile);

        // Update UI
        this.loadDeckCards(); // This will update topbar

        // Show success message
        const currencyEmojis = {
          gears: '⚙️',
          bolts: '🔩',
          cores: '✴︎'
        };
        alert(`✅ ${card.name} куплено за ${price} ${currencyEmojis[currency]}!`);

        // Reload cards
        this.loadShopCards(this.currentCardFilter || 'all');
      },

      renderProducts(containerId, products) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';

        products.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';

          const currencyEmojis = {
            bolts: '🔩',
            gears: '⚙️',
            cores: '✴︎'
          };
          const currencyIcon = currencyEmojis[product.price.currency] || '?';
          const badgeHTML = product.badge 
            ? `<div class="product-badge ${product.badge.class}">${product.badge.text}</div>` 
            : '';
          const bonusHTML = product.bonus 
            ? `<div class="product-bonus">${product.bonus}</div>` 
            : '';

          card.innerHTML = `
            ${badgeHTML}
            <div class="product-header">
              <div class="product-icon">${product.icon}</div>
              <div class="product-info">
                <div class="product-title">${product.title}</div>
                <div class="product-desc">${product.description}</div>
                ${bonusHTML}
              </div>
            </div>
            <div class="product-footer">
              <div class="product-price">
                <span class="currency-icon">${currencyIcon}</span>
                <span>${product.price.amount}</span>
              </div>
              <button class="product-buy-btn" data-sku="${product.sku}">Купити</button>
            </div>
          `;

          container.appendChild(card);
        });

        // Add click handlers
        container.querySelectorAll('.product-buy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const sku = btn.dataset.sku;
            this.buyProduct(sku);
          });
        });
      },

      canAfford(product) {
        const profile = this.getProfile();
        if (!profile) return false;

        const currency = product.price.currency;
        return profile[currency] >= product.price.amount;
      },

      buyProduct(sku) {
        console.log('[BUY] Starting purchase for SKU:', sku);
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('[BUY] No profile found!');
          return;
        }
        console.log('[BUY] Profile loaded:', profile);

        const allProducts = this.getShopProducts();
        const product = [...allProducts.offers, ...allProducts.singleCards]
          .find(p => p.sku === sku);

        if (!product) {
          console.error('[BUY] Product not found:', sku);
          alert('Товар не знайдено!');
          return;
        }

        // КРОК 1: Перевірка можливості покупки
        const canAfford = this.canAfford(profile, product.price);
        if (!canAfford) {
          console.warn('[BUY] Cannot afford. Need:', product.price.amount, 'Have:', profile[product.price.currency]);
          const currencyNames = {
            bolts: 'болтів',
            gears: 'шестерень',
            cores: 'парових ядер'
          };
          const currencyName = currencyNames[product.price.currency] || 'валюти';
          alert(`Недостатньо ${currencyName}! Потрібно ${product.price.amount}`);
          return;
        }

        // КРОК 2: Списання валюти
        const currency = product.price.currency;
        profile[currency] -= product.price.amount;
        console.log('[BUY] Currency deducted. New balance:', profile[currency]);

        // КРОК 3: Видача нагород (карти або валюта)
        const rewards = [];

        if (product.contents.cards) {
          console.log('[BUY] Granting pack of', product.contents.cards, 'cards');
          // Mark SKU so grantPack can apply product-specific drop options
          profile._lastPurchasedSku = sku;
          const cards = this.grantPack(profile, product.contents.cards);
          // cleanup helper flag
          delete profile._lastPurchasedSku;
          rewards.push(...cards);
        }

        // Видача інших нагород (гарний бонус)
        if (product.contents.gears) {
          profile.gears = (profile.gears || 0) + product.contents.gears;
        }
        if (product.contents.cores) {
          profile.cores = (profile.cores || 0) + product.contents.cores;
        }
        if (product.contents.bolts) {
          profile.bolts = (profile.bolts || 0) + product.contents.bolts;
        }

        // КРОК 4: Позначити одноразові товари як куплені
        if (sku === 'offer_elements') {
          if (!profile.purchasedOffers) {
            profile.purchasedOffers = [];
          }
          profile.purchasedOffers.push(sku);
        }

        // КРОК 5: Збереження профілю
        userProfile.updateCurrentUser(profile);
        console.log('[BUY] Profile saved');

        // КРОК 6: Оновлення UI
        userProfile.updateUI();
        console.log('[BUY] UI updated');

        // КРОК 7: Перезавантажити магазин (приховати одноразові товари)
        if (sku === 'offer_elements') {
          this.loadShop();
        }

        // КРОК 8: Показ модалки з нагородами
        console.log('[BUY] Purchase complete! Rewards:', rewards.length, 'cards');
        if (rewards.length > 0) {
          this.showPackModal(rewards);
        } else {
          alert(`✅ Покупка успішна!`);
        }
      },

      // Функція для перевірки можливості покупки
      canAfford(profile, price) {
        const { currency, amount } = price;
        return (profile[currency] ?? 0) >= amount;
      },

      grantPack(profile, count) {
        let allCards = window.ALL_CARDS || [];
        const rewards = [];

        // Ініціалізувати інвентар якщо не існує
        if (!profile.inventory) {
          profile.inventory = {};
        }
        if (!profile.collectionCards) {
          profile.collectionCards = [];
        }

        for (let i = 0; i < count; i++) {
          let card = null;
          const sku = profile._lastPurchasedSku || '';

          // РІЗНІ ТИПИ ПАКІВ З РІЗНИМИ ОБМЕЖЕННЯМИ
          if (sku === 'card_uncommon') {
            // "Незвичайна карта" - 500 болтів
            // ОБМЕЖЕННЯ: Тільки R1-R4 (без легендарних/міфічних)
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 60) {
              targetRarity = 'common';       // 60% - Звичайна (R1)
            } else if (rarityRoll < 75) {
              targetRarity = 'uncommon';     // 15% - Незвичайна (R2)
            } else if (rarityRoll < 90) {
              targetRarity = 'rare';         // 15% - Рідкісна (R3)
            } else {
              targetRarity = 'epic';         // 10% - Епічна (R4)
            }
            
            // Фільтруємо карти тільки з дозволеними рідкостями
            const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
            const candidates = allCards.filter(c => 
              allowedRarities.includes(c.rarity) && c.rarity === targetRarity
            );
            
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // Резервний варіант: будь-яка карта R1-R4
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'card_epic') {
            // "Епічна карта" - 50 шестерень
            // ОБМЕЖЕННЯ: R4-R6 з шансами 50%/30%/20%
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 50) {
              targetRarity = 'epic';       // 50% - Епічна (R4)
            } else if (rarityRoll < 80) {
              targetRarity = 'legendary';  // 30% - Легендарна (R5)
            } else {
              targetRarity = 'mythic';     // 20% - Міфічна (R6)
            }
            
            // Фільтруємо карти тільки з дозволеними рідкостями
            const allowedRarities = ['epic', 'legendary', 'mythic'];
            const candidates = allCards.filter(c => 
              allowedRarities.includes(c.rarity) && c.rarity === targetRarity
            );
            
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // Якщо немає карт цієї рідкості, беремо будь-яку з дозволених
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'card_legendary') {
            // "Легендарна карта" - 150 шестерень
            // ОБМЕЖЕННЯ: Гарантовано легендарна (R5) або міфічна (R6)
            const allowedRarities = ['legendary', 'mythic'];
            
            // 80% шанс на R5, 20% на R6
            const isMythic = Math.random() < 0.2;
            const targetRarity = isMythic ? 'mythic' : 'legendary';
            
            const candidates = allCards.filter(c => c.rarity === targetRarity);
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // Якщо немає міфічних, беремо легендарну, і навпаки
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'offer_elements') {
            // "Колекція елементалів" - 20 шестерень
            // ОБМЕЖЕННЯ: Тільки R1-R4 (без легендарних/міфічних)
            const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
            
            // Для наборів - рівномірний розподіл
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 25) {
              targetRarity = 'common'; // 25% - Звичайна
            } else if (rarityRoll < 50) {
              targetRarity = 'uncommon'; // 25% - Незвичайна
            } else if (rarityRoll < 75) {
              targetRarity = 'rare'; // 25% - Рідкісна
            } else {
              targetRarity = 'epic'; // 25% - Епічна
            }
            
            const candidates = allCards.filter(c => c.rarity === targetRarity);
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else {
            // Для інших товарів (якщо використовується dropSystem)
            if (window.dropSystem && typeof window.dropSystem.dropCardWithOptions === 'function') {
              let opts = {};
              
              // Налаштування для різних SKU
              if (sku && sku.startsWith('card_')) {
                opts = { maxRarity: 'epic' }; // За замовчуванням - без легендарних
              }
              
              const res = window.dropSystem.dropCardWithOptions(
                profile, 
                allCards, 
                window.STARTER_CARDS || [], 
                profile.pityCounters || {noLegendary:0, noMythic:0}, 
                opts
              );
              card = res.card;
              profile.pityCounters = res.pityCounters;
              console.log(`[GRANTPACK] ${sku}: DropSystem ${card.rarity} - ${card.name}`);
            } else {
              // Fallback: випадкова карта з обмеженнями
              const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
          }

          const newEntry = { id: card.id, level: 1 };

          // ДОДАТИ В КОЛЕКЦІЮ
          profile.collectionCards.push(newEntry);
          userProfile.autoAddToDeck(profile, newEntry);

          // ДОДАТИ В ІНВЕНТАР (для прокачки)
          profile.inventory[card.id] = (profile.inventory[card.id] ?? 0) + 1;

          // ЗБЕРЕГТИ ДЛЯ ПОКАЗУ В МОДАЛЦІ
          rewards.push(card);
        }

        return rewards;
      },

      showPackModal(rewards) {
        const modal = document.getElementById('pack-modal');
        const rewardsContainer = document.getElementById('pack-rewards');
        if (!modal || !rewardsContainer) return;
        rewardsContainer.innerHTML = '';

        // Render rewards: prefer createCardView, then cardRenderer, otherwise fallback HTML
        rewards.forEach(card => {
          const wrapper = document.createElement('div');
          wrapper.className = 'pack-card-wrapper';

          let visualAppended = false;
          if (window.createCardView) {
            try {
              const cardEl = window.createCardView(card);
              if (cardEl) {
                wrapper.appendChild(cardEl);
                visualAppended = true;
              }
            } catch (err) {
              console.warn('createCardView failed in pack modal', err);
            }
          }

          if (!visualAppended && window.cardRenderer && typeof window.cardRenderer.render === 'function') {
            try {
              const html = window.cardRenderer.render(card);
              const frag = document.createElement('div');
              frag.innerHTML = html;
              // append first node
              if (frag.firstElementChild) wrapper.appendChild(frag.firstElementChild);
              visualAppended = true;
            } catch (err) {
              console.warn('cardRenderer.render failed in pack modal', err);
            }
          }

          if (!visualAppended) {
            // Minimal fallback visual
            const el = document.createElement('div');
            el.className = 'sp-card pack-fallback-card ' + (card.element || '');
            el.innerHTML = `
              <div class="corner-gear">${card.element || ''}</div>
              <div class="power-plate"><div class="power-value">${card.basePower || card.power || ''}</div></div>
            `;
            wrapper.appendChild(el);
          }

          // Info under card
          const info = document.createElement('div');
          info.className = 'pack-card-info';
          const nameDiv = document.createElement('div');
          nameDiv.className = 'pack-card-name';
          nameDiv.textContent = card.name || '';
          info.appendChild(nameDiv);
          const elDiv = document.createElement('div');
          elDiv.className = 'pack-card-element';
          let elementName = card.element;
          if (window.ELEMENT_INFO && window.ELEMENT_INFO[card.element] && window.ELEMENT_INFO[card.element].name) {
            elementName = window.ELEMENT_INFO[card.element].name;
          }
          elDiv.textContent = elementName || '';
          info.appendChild(elDiv);

          wrapper.appendChild(info);
          rewardsContainer.appendChild(wrapper);
        });
        modal.classList.add('active');
      },

      closePackModal() {
        const modal = document.getElementById('pack-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      },

      // ========== END SHOP SYSTEM ==========

      loadDeckCards() {
        // Оновити дані користувача на топбарі
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('No user profile found');
          return;
        }

        const boltsEl = document.getElementById('deck-bolts');
        const gearsEl = document.getElementById('deck-gears');
        const coresEl = document.getElementById('deck-cores');
        
        if (boltsEl) boltsEl.textContent = profile.bolts || 0;
        if (gearsEl) gearsEl.textContent = profile.gears || 0;
        if (coresEl) coresEl.textContent = profile.cores || 0;

        // Ініціалізувати карти якщо їх немає (для старих користувачів)
        if (!profile.deckCards || !profile.collectionCards) {
          console.log('Initializing cards for existing user...');
          const selectedCards = getRandomCards(16);
          profile.deckCards = selectedCards.slice(0, 9).map(card => ({
            id: card.id,
            level: 1
          }));
          profile.collectionCards = selectedCards.slice(9, 16).map(card => ({
            id: card.id,
            level: 1
          }));
          userProfile.updateCurrentUser(profile);
        }

        // Міграція старих користувачів: додати progress і inventory
        if (!profile.progress) {
          console.log('Migrating profile: adding progress...');
          profile.progress = {};
          const allCards = profile.deckCards.concat(profile.collectionCards || []);
          allCards.forEach(dc => {
            if (dc && dc.id) {
              profile.progress[dc.id] = { level: dc.level || 1, xp: 0 };
            }
          });
        }

        if (!profile.inventory) {
          console.log('Migrating profile: adding inventory...');
          profile.inventory = {};
          const allCards = profile.deckCards.concat(profile.collectionCards || []);
          allCards.forEach(dc => {
            if (dc && dc.id) {
              profile.inventory[dc.id] = (profile.inventory[dc.id] || 0) + 1;
            }
          });
        }

        // Build deck entries with resolved card data and computed power
        const deckEntries = (profile.deckCards || [])
          .map(dc => {
            const card = getCardById(dc.id);
            const level = dc.level || 1;
            const power = card ? (window.getPower ? window.getPower(card, level) : (card.basePower || card.power || 0)) : 0;
            return { id: dc.id, level, card, power };
          })
          .filter(e => e.card);

        // Sort from strongest to weakest by computed power
        deckEntries.sort((a, b) => (b.power || 0) - (a.power || 0));

        // Persist sorted order into profile.deckCards so event handlers map correctly
        profile.deckCards = deckEntries.map(e => ({ id: e.id, level: e.level }));
        if (typeof userProfile.updateCurrentUser === 'function') userProfile.updateCurrentUser(profile);

        const deckCards = deckEntries.map(e => e.card);
        
        // Перевірка чи карти знайдені
        if (deckCards.length === 0) {
          console.error('No cards found! Check if card scripts are loaded.');
          document.getElementById('deckGrid').innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Помилка завантаження карт</p>';
          return;
        }
        
        console.log('Loading deck cards:', deckCards.length, 'cards found');
        console.log('First card:', deckCards[0]);
        
        // Рендеринг карт
        const deckGrid = document.getElementById('deckGrid');
        if (deckGrid) {
          const cardsHTML = deckCards
            .map((card, index) => {
              const cardLevel = profile.deckCards[index].level || 1;
              return this.renderDeckCard(card, cardLevel);
            })
            .join('');
          
          console.log('Generated HTML length:', cardsHTML.length);
          deckGrid.innerHTML = cardsHTML;
          console.log('Cards rendered to grid');
          // Ініціалізація паралаксу для карт після рендеру
          initCardParallax();
        }
        
        // Оновити силу колоди (з урахуванням рівня прогресу)
        let totalPower = 0;
        deckCards.forEach((card) => {
          const prog = window.getProgress ? window.getProgress(profile, card.id) : { level: 1, xp: 0 };
          const cardLevel = prog.level;
          totalPower += window.getPower ? window.getPower(card, cardLevel) : getPower(card, cardLevel);
        });
        
        const powerDisplay = document.getElementById('deck-power-value');
        if (powerDisplay) {
          powerDisplay.textContent = totalPower;
        }
        
        // Прикріпити обробники подій
        const profileForUpgrade = userProfile.getProfile();
        const inventory = this.getInventory(profileForUpgrade);
        
        // Оновити стан hint-у
        const hintEl = document.getElementById('deck-hint');
        if (hintEl) {
          if (this.hasAnyUpgradable(profileForUpgrade.deckCards, inventory)) {
            hintEl.classList.add('hot');
          } else {
            hintEl.classList.remove('hot');
          }
        }
        
        document.querySelectorAll('#deckGrid .sp-card').forEach((cardEl, index) => {
          const deckItem = profileForUpgrade.deckCards[index];
          const canUpgrade = this.canUpgradeCard(deckItem, inventory);
          
          cardEl.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Показати сторінку деталей карти при кліку
            // (навіть якщо не можна апгрейдити - просто для перегляду)
            this.showCardDetails(deckItem.id, true, index);
          });
        });
      },

      renderDeckCard(cardData, level = 1) {
        const profile = userProfile.getProfile();
        const inventory = this.getInventory(profile);
        const prog = window.getProgress ? window.getProgress(profile, cardData.id) : { level: level, xp: 0 };
        const displayLevel = prog.level || level;
        const displayPower = window.getPower ? window.getPower(cardData, displayLevel) : getPower(cardData, displayLevel);
        const canUpgrade = this.canUpgradeCard({ id: cardData.id, level: displayLevel }, inventory);
        const canAutoLevel = canUpgrade && this.canGuaranteedLevelByBurning(profile, cardData.id);
        
        // Використовуємо CardRenderer якщо доступний
          if (window.cardRenderer) {
          // Передаємо атаку як актуальну силу, щоб рендер показував прокачку
          const boostedCard = { 
            ...cardData, 
            attack: displayPower,
            power: displayPower,
            stats: { ...(cardData.stats || {}), power: displayPower }
          };
          let html = window.cardRenderer.render(boostedCard, { level: displayLevel, power: displayPower, showUpgrade: canAutoLevel, interactive: true });
          return html;
        }

        // Fallback рендеринг - однаковий шаблон як CardRenderer
        const {
          id = 'unknown',
          element = 'fire',
          rarity = 'R1',
          basePower = 0,
          attack = displayPower
        } = cardData;

        const rarityNames = {
          'R1': 'ЗВИЧАЙНА',
          'R2': 'НЕЗВИЧАЙНА',
          'R3': 'РІДКІСНА',
          'R4': 'ЕПІЧНА',
          'R5': 'ЛЕГЕНДАРНА',
          'R6': 'МІФІЧНА'
        };

        const rarityBadge = rarityNames[rarity] || 'ЗВИЧАЙНА';
        const shownPower = attack || basePower;

        const elementIcons = {
          fire: `<div class="element-emoji fire-emoji">🔥</div>`,
          water: `<div class="element-emoji water-emoji">💧</div>`,
          air: `<div class="element-emoji air-emoji">💨</div>`,
          earth: `<div class="element-emoji earth-emoji">🍃</div>`
        };

        const elementIcon = elementIcons[element] || elementIcons.fire;

        return `
          <div class="sp-card ${element} ${rarity} ${canUpgrade ? 'upgradable' : ''}" 
               data-id="${id}"
               data-card-id="${id}"
               data-element="${element}"
               data-rarity="${rarity}"
               data-power="${shownPower}"
               data-attack="${attack}">
            <!-- ДЕКОРАТИВНІ ЛІНІЇ -->
            <div class="decor-line line-top"></div>
            <div class="decor-line line-bottom"></div>
            <!-- БЕЙДЖ РІДКОСТІ -->
            <div class="rarity-badge">${rarityBadge}</div>
            <!-- ВЕЛИКА ДЕТАЛЬНА ШЕСТЕРНЯ -->
            <div class="corner-gear">
              <div class="gear-inner">
                ${elementIcon}
              </div>
            </div>
            <!-- ПЛАШКА СИЛИ внизу -->
            <div class="power-plate">
              <div class="power-value">${shownPower}</div>
            </div>
            ${canAutoLevel ? '<div class="upgrade-arrow">▲</div>' : ''}
          </div>
        `;
      },

      // Оновлення сили карти в DOM після прокачки
      refreshCardPowerInDeck(cardId) {
        const profile = userProfile.getProfile();
        const cardData = window.getCardById(cardId);
        if (!cardData) return;

        const prog = window.getProgress ? window.getProgress(profile, cardId) : { level: 1, xp: 0 };
        const newPower = window.getPower ? window.getPower(cardData, prog.level) : cardData.basePower;

        // Оновити силу в DOM
        const powerEl = document.querySelector(
          `.sp-card[data-card-id="${cardId}"] .power-value`
        );
        if (powerEl) {
          powerEl.textContent = String(newPower);
        }

        // Оновити атрибути data-power та data-attack
        const cardEl = document.querySelector(`.sp-card[data-card-id="${cardId}"]`);
        if (cardEl) {
          cardEl.setAttribute('data-power', newPower);
          cardEl.setAttribute('data-attack', newPower);
        }

        // Оновити загальну силу колоди
        this.loadDeckCards();
      },

      loadCollectionCards() {
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('No profile found');
          return;
        }

        // Знайдені карти (ID): з колекції та колоди
        let foundIds = new Set([
          ...((profile.collectionCards || []).map(c => c.id)),
          ...((profile.deckCards || []).map(c => c.id))
        ]);

        // Все карты по элементам
        let allCards = window.ALL_CARDS || [];
        const elements = ['fire', 'water', 'air', 'earth'];
        const elementNames = {
          fire: 'Вогняна стихія',
          water: 'Водяна стихія',
          air: 'Повітряна стихія',
          earth: 'Земляна стихія'
        };

        elements.forEach(element => {
          const grid = document.getElementById(element + '-collection');
          if (!grid) return;
          const cards = allCards.filter(card => card.element === element);
          let foundCount = 0;
          grid.innerHTML = cards.map(card => {
            const found = foundIds.has(card.id);
            if (found) foundCount++;
            return `
              <div class="collection-card-item${found ? ' found' : ' not-found'}">
                <span class="collection-card-name">${card.name}</span>
                <span class="collection-card-status">${found ? 'Знайдено' : 'Не знайдено'}</span>
              </div>
            `;
          }).join('');
          // Обновить прогресс
          const progress = document.getElementById(element + '-progress');
          if (progress) progress.textContent = `${foundCount}/${cards.length} карт`;
        });
      },

      // ========== CARD DETAILS PAGE ==========

      showCardDetails(cardId, fromDeck = false, deckIndex = -1) {
        const profile = userProfile.getProfile();
        const cardData = getCardById(cardId);

        if (!cardData) {
          console.error('Card not found:', cardId);
          return;
        }

        // Визначити рівень за прогресом (прокачка)
        const prog = window.getProgress ? window.getProgress(profile, cardId) : { level: 1, xp: 0 };
        const cardLevel = prog.level;
        const actualPower = window.getPower ? window.getPower(cardData, cardLevel) : Math.round(cardData.basePower * Math.pow(cardData.upgradeMult, cardLevel - 1));

        // Рендерити основну інформацію про карту
        this.renderCardDetails(cardData, cardLevel, actualPower, deckIndex);

        // Знайдені карти (ID): з колекції та колоди
        const foundIds = new Set([
          ...((profile.collectionCards || []).map(c => c.id)),
          ...((profile.deckCards || []).map(c => c.id))
        ]);
        // Знайти всі карти цієї стихії (з бази даних)
        const allCards = window.ALL_CARDS || window.CARDS_COMMON || [];
        const sameElementCards = allCards.filter(c => c.element === cardData.element);
        // Визначити силу цільової карти через getPower (з урахуванням рівня прогресу)
        const targetPower = window.getPower ? (window.getPower(cardData, cardLevel)) : (cardData.basePower || cardData.power || 0);
        const deckIds = new Set((profile.deckCards || []).map(c => c.id));
        // Всі слабші карти цієї стихії, які знайдені у профілі, але НЕ в колоді
        const weakerCards = sameElementCards.filter(c => {
          if (!c || !c.id) return false;
          if (!foundIds.has(c.id)) return false;
          if (deckIds.has(c.id)) return false;
          // вычислим силу кандидата (используем getPower если есть и учитываем его прогресс)
          const candProg = window.getProgress ? window.getProgress(profile, c.id) : { level: 1, xp: 0 };
          const candPower = window.getPower ? window.getPower(c, candProg.level) : (c.basePower || c.power || 0);
          return candPower < targetPower && c.id !== cardId;
        });

        // Показ/скрытие заголовка и списка слабших карт
        const weakerHeader = document.getElementById('weaker-cards-header');
        const weakerList = document.getElementById('weaker-cards-list');
        if (weakerCards.length > 0) {
          if (weakerHeader) weakerHeader.style.display = '';
          if (weakerList) weakerList.style.display = '';
          this.renderWeakerCards(weakerCards, cardId, profile);
        } else {
          if (weakerHeader) weakerHeader.style.display = 'none';
          if (weakerList) {
            weakerList.style.display = 'none';
            weakerList.innerHTML = '';
          }
        }

        // === ПРОСТА ВІЗУАЛІЗАЦІЯ ПРОКАЧКИ ===
        // Покажемо простий XP-бар або викличемо внешнюю отрисовку, якщо доступна
        const cardMain = document.getElementById('card-main-info');
        const xpBar = cardMain ? cardMain.querySelector('.xp-bar') : null;
        if (window.renderUpgradeBar) {
          window.renderUpgradeBar(profile, cardId);
        } else if (xpBar) {
          const need = this.xpNeededForLevel(prog.level || 1) || 100;
          xpBar.style.width = `${Math.min(100, Math.round(((prog.xp || 0) / need) * 100))}%`;
        }
        // Обновити кнопку "Назад"
        const backBtn = document.getElementById('card-details-back');
        if (backBtn) {
          backBtn.onclick = (e) => {
            e.preventDefault();
            if (fromDeck) {
              this.showPage('deck');
            } else {
              this.showPage('collections');
            }
          };
        }

        // Показати сторінку
        this.showPage('card-details');
      },
      renderCardDetails(cardData, level, power, deckIndex) {
        const mainDisplay = document.getElementById('card-main-info');
        if (!mainDisplay) return;

        // Визуальный блок карточки — используем единый рендерер (renderDeckCard) или cardRenderer/createCardView, иначе fallback
        let visualHtml = '';
        try {
          if (typeof this.renderDeckCard === 'function') {
            visualHtml = this.renderDeckCard({ ...cardData }, level);
          } else if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
            // Передаем power & level через opts, чтобы рендерер использовал актуальную силу
            visualHtml = window.cardRenderer.render({ ...cardData }, { level, power });
          } else if (window.createCardView) {
            const el = window.createCardView({ ...cardData, power, level });
            visualHtml = el ? el.outerHTML : '';
          }
        } catch (err) {
          console.warn('visual card render failed', err);
          visualHtml = '';
        }

        if (!visualHtml) {
          // Простой fallback визуал
          const elem = cardData.element || '';
          const shownPower = power || cardData.basePower || 0;
          visualHtml = `
            <div class="sp-card large ${elem}">
              <div class="corner-gear">${elem}</div>
              <div class="power-plate"><div class="power-value">${shownPower}</div></div>
              <div class="card-name">${cardData.name || ''}</div>
            </div>`;
        }

        // Инфо справа: имя, стихия, редкость, уровень
        const prog = (userProfile.getProfile && window.getProgress) ? window.getProgress(userProfile.getProfile(), cardData.id) : { level: level || 1, xp: 0 };
        const levelText = `LV ${prog.level || level || 1}`;
        const need = this.xpNeededForLevel(prog.level || 1) || 100;
        const xpText = `${prog.xp || 0} / ${need} XP`;

        mainDisplay.innerHTML = `
          <div style="display:flex; gap:14px; align-items:flex-start;">
            <div class="card-visual-area">${visualHtml}</div>
            <div class="card-meta" style="flex:1">
              <div class="card-meta-name" style="font-size:18px; font-weight:700; margin-bottom:6px">${cardData.name || ''}</div>
              <div class="card-meta-row">Стихія: <strong>${(cardData.element || '').toUpperCase()}</strong></div>
              <div class="card-meta-row">Рідкість: <strong>${cardData.rarity || ''}</strong></div>
              <div class="card-meta-row" style="margin-top:8px">Рівень: <span id="cu-level-inner">${levelText}</span></div>
              <div class="card-meta-row">XP: <span id="cu-xp-text-inner">${xpText}</span></div>
            </div>
          </div>`;

        // Обновляем глобальную панель прокачки в секции деталей
        const cuLevel = document.getElementById('cu-level');
        const cuXpText = document.getElementById('cu-xp-text');
        const cuXpFill = document.getElementById('cu-xp-fill');
        if (cuLevel) cuLevel.textContent = levelText;
        if (cuXpText) cuXpText.textContent = xpText;
        if (cuXpFill) cuXpFill.style.width = `${Math.min(100, Math.round(((prog.xp || 0) / need) * 100))}%`;

        // Настройка кнопок действий
        const addBtn = document.getElementById('card-add-to-deck-btn');
        const removeBtn = document.getElementById('card-remove-btn');
        const upgradeBtn = document.getElementById('card-upgrade-btn');

        if (addBtn) {
          addBtn.onclick = (e) => {
            e.preventDefault();
            const profile = userProfile.getProfile();
            const res = userProfile.autoAddToDeck(profile, { id: cardData.id, level: prog.level || 1 });
            if (res.added || res.replaced) {
              userProfile.updateCurrentUser(profile);
              this.loadDeckCards();
              this.loadCollectionCards();
              alert('Карта додана в колоду');
            } else {
              alert('Не вдалося додати карту в колоду');
            }
          };
        }

        if (removeBtn) {
          removeBtn.onclick = (e) => {
            e.preventDefault();
            const profile = userProfile.getProfile();
            // Удаляем карту из коллекции и/или из колоды
            if (profile.collectionCards) {
              for (let i = profile.collectionCards.length - 1; i >= 0; i--) {
                if (profile.collectionCards[i].id === cardData.id) {
                  profile.collectionCards.splice(i, 1);
                  break;
                }
              }
            }
            if (profile.deckCards) {
              for (let i = profile.deckCards.length - 1; i >= 0; i--) {
                if (profile.deckCards[i].id === cardData.id) {
                  profile.deckCards.splice(i, 1);
                  break;
                }
              }
            }
            userProfile.updateCurrentUser(profile);
            this.loadDeckCards();
            this.loadCollectionCards();
            this.showPage('collections');
          };
        }

        // Кнопка прокачки удалена — ничего не делаем
        try {
          const upgradeBtnEl = document.getElementById('card-upgrade-btn');
          if (upgradeBtnEl) {
            upgradeBtnEl.style.display = 'none';
            upgradeBtnEl.onclick = null;
          }
          const cuBtn = document.getElementById('cu-upgrade-btn');
          if (cuBtn) cuBtn.remove();
        } catch (err) {
          console.warn('upgrade button cleanup failed', err);
        }
      },

        // Рендер списка слабших карт: плитки с визуалом (использует cardRenderer, если доступен)
        renderWeakerCards(weakerCards, targetCardId, profile) {
          const list = document.getElementById('weaker-cards-list');
          if (!list) return;
          const targetCard = window.getCardById ? window.getCardById(targetCardId) : null;

          // Создаём сетку
          const tiles = weakerCards.map(c => {
            const card = (c && c.id && window.getCardById) ? window.getCardById(c.id) : c;
            if (!card) return '';

            // Процентный показатель: сколько XP даст спалення этой карты относительно нужного XP для следующего уровня
            const progTarget = (profile && profile.progress && profile.progress[targetCardId]) ? profile.progress[targetCardId] : { level: 1, xp: 0 };
            const need = this.xpNeededForLevel(progTarget.level) || 100;
            const cardPower = card.basePower || card.power || 0;
            const xpGain = cardPower || 10;
            const pct = Math.max(0, Math.min(100, Math.round((xpGain / need) * 100)));

            // Use same renderer as deck to ensure visuals match deck cards
            let cardHtml = '';
            try {
              const candProg = (window.getProgress && profile) ? (window.getProgress(profile, card.id) || { level: 1 }) : { level: 1 };
              // Prefer the site's deck renderer so weaker-card tiles look identical to deck cards
              if (typeof this.renderDeckCard === 'function') {
                cardHtml = this.renderDeckCard(card, candProg.level || 1);
              } else if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
                cardHtml = window.cardRenderer.render({ ...card, power: cardPower });
              } else if (window.createCardView) {
                const el = window.createCardView(card);
                cardHtml = el ? el.outerHTML : '';
              } else {
                // fallback минимальный визуал
                cardHtml = `
                  <div class="sp-card ${card.element || ''}">
                    <div class="corner-gear">${card.element || ''}</div>
                    <div class="power-plate"><div class="power-value">${cardPower}</div></div>
                    <div class="card-name">${card.name}</div>
                  </div>`;
              }
            } catch (err) {
              console.warn('weaker card render failed, fallback used', err);
              cardHtml = `
                <div class="sp-card ${card.element || ''}">
                  <div class="corner-gear">${card.element || ''}</div>
                  <div class="power-plate"><div class="power-value">${cardPower}</div></div>
                  <div class="card-name">${card.name}</div>
                </div>`;
            }

            return `
              <div class="weaker-card-tile" data-card-id="${card.id}">
                <div class="weaker-card-visual tile">${cardHtml}</div>
                <div class="weaker-card-footer">
                  <div class="weaker-card-power">${cardPower}</div>
                  <div class="weaker-card-pct">+${pct}%</div>
                </div>
              </div>`;
          }).join('');

          // Use horizontal weaker-cards container so rows don't stretch the page
          list.innerHTML = `<div class="weaker-cards">${tiles}</div>`;

          // Добавляем обработчик клика на плитку: просто нажимаешь на карту — она сгорает
          list.querySelectorAll('.weaker-card-tile').forEach(tile => {
            tile.addEventListener('click', (e) => {
              const srcId = tile.dataset.cardId;
              if (!srcId) return;
              const result = this.burnCardForXP(profile, srcId, targetCardId);
              if (result && result.success) {
                // Удаляем плитку из DOM
                tile.remove();
                userProfile.updateCurrentUser(profile);
                // Обновляем списки
                this.loadCollectionCards();
                this.loadDeckCards();
                // Обновим детали если мы на странице картки
                if (this.currentPage === 'card-details') {
                  this.renderCardDetails(window.getCardById(targetCardId), result.newLevel, result.newPower || 0, -1);
                  if (window.renderUpgradeBar) window.renderUpgradeBar(profile, targetCardId);
                }
                // Без alert'а — карточка исчезла и прогресс обновлён
              } else {
                console.warn(result && result.error ? result.error : 'Не вдалося спалити карту');
              }
            });
          });
        },

        // Сжечь карту из коллекции/інвентаря ради XP целевой карты (без подтверждений)
        burnCardForXP(profile, sourceCardId, targetCardId) {
          if (!profile || !sourceCardId || !targetCardId) return { success: false, error: 'Невірні параметри' };

          // Найти и удалить одну копию из collectionCards (предпочтительно из коллекции, а не из колоды)
          let removed = false;
          let removedFromInventory = false;
          if (Array.isArray(profile.collectionCards)) {
            for (let i = profile.collectionCards.length - 1; i >= 0; i--) {
              if (profile.collectionCards[i].id === sourceCardId) {
                profile.collectionCards.splice(i, 1);
                removed = true;
                break;
              }
            }
          }

          // Если не найдено в коллекции, попробуем удалить из инвентаря напрямую (inventory счетчик)
          if (!removed && profile.inventory && profile.inventory[sourceCardId] > 0) {
            profile.inventory[sourceCardId] = Math.max(0, profile.inventory[sourceCardId] - 1);
            removed = true;
            removedFromInventory = true;
          }

          if (!removed) return { success: false, error: 'Копія карти не знайдена для спалення' };

          // Определяем XP-гив (используем силу карты как базовый XP)
          const srcCard = window.getCardById ? window.getCardById(sourceCardId) : null;
          const tgtCard = window.getCardById ? window.getCardById(targetCardId) : null;
          const xpGain = srcCard ? (srcCard.basePower || srcCard.power || 10) : 10;

          // Убедимся, что структура progress есть
          if (!profile.progress) profile.progress = {};
          if (!profile.progress[targetCardId]) profile.progress[targetCardId] = { level: 1, xp: 0 };

          // Добавляем XP используя глобальную систему (если доступна), чтобы избежать рассинхрона
          if (window.addXp && window.getProgress) {
            window.addXp(profile, targetCardId, xpGain);
            const prog = window.getProgress(profile, targetCardId);
            var newLevel = prog.level || 1;
            var leveled = true; // неважно точно число — мы вернём факт успеха
          } else {
            // fallback: локальная обработка (устаревшая логика)
            profile.progress[targetCardId].xp = (profile.progress[targetCardId].xp || 0) + xpGain;
            let leveledLocal = false;
            let newLevelLocal = profile.progress[targetCardId].level || 1;
            while (profile.progress[targetCardId].xp >= this.xpNeededForLevel(newLevelLocal)) {
              profile.progress[targetCardId].xp -= this.xpNeededForLevel(newLevelLocal);
              newLevelLocal += 1;
              leveledLocal = true;
            }
            profile.progress[targetCardId].level = newLevelLocal;
            var newLevel = newLevelLocal;
            var leveled = leveledLocal;
          }

          // Если карта была удалена из коллекции, не трогаем inventory; если удалена из inventory, уже уменьшили выше

          // Синхронизировать уровень в записи колоды, если карта там присутствует
          if (Array.isArray(profile.deckCards)) {
            for (let i = 0; i < profile.deckCards.length; i++) {
              if (profile.deckCards[i] && profile.deckCards[i].id === targetCardId) {
                profile.deckCards[i].level = newLevel;
                break;
              }
            }
          }

          // Сохранение выполняется вызывающей стороной
          const newPower = tgtCard ? (window.getPower ? window.getPower(tgtCard, newLevel) : (tgtCard.basePower || 0)) : null;

          return { success: true, leveled, newLevel, newPower };
        },

      // ========== DUELS (MVP) ==========
      
      // ========== DUELS (MVP) ========== 
      updatePlayerMultiplierPreview() {
        if (!window.CURRENT_DUEL) return;
        const duel = window.CURRENT_DUEL;
        // Populate per-column multiplier slots if available
        for (let i = 0; i < 3; i++) {
          const multSlot = document.getElementById(`multSlot${i}`);
          if (!multSlot) continue;
          const pCard = duel.player.hand[i];
          const eCard = duel.enemy.hand[i];
          if (!pCard || !eCard) {
            multSlot.innerHTML = '<div class="mult mult-neutral" style="opacity:0.3"><span class="mult-text">—</span></div>';
            continue;
          }
          const mult = (window.MULT && window.MULT[pCard.element] && window.MULT[pCard.element][eCard.element]) ?? 1;
          const multClass = mult > 1 ? 'mult-good' : mult < 1 ? 'mult-bad' : 'mult-neutral';
          const multText = mult === 1 ? '× 1' : `× ${mult.toFixed(1)}`;
          multSlot.innerHTML = `<button class="mult ${multClass}" data-slot="${i}" data-mult="${mult}"><span class="mult-text">${multText}</span></button>`;
        }
      },
      
      initDuelsPage() {
        const btn = document.getElementById('duel-start-btn');
        if (btn) {
          // Скрываем ручную кнопку — поиск будет автоматическим
          btn.style.display = 'none';
        }
        // Clear UI and show searching state
        const enemyHpEl = document.getElementById('enemyHp');
        const playerHpEl = document.getElementById('playerHp');
        const enemyHandEl = document.getElementById('enemyHand');
        const playerHandEl = document.getElementById('playerHand');
        const duelLogEl = document.getElementById('duelLog');
        // update both legacy text nodes and new HUD elements
        if (enemyHpEl) enemyHpEl.textContent = '0/0';
        if (playerHpEl) playerHpEl.textContent = '0/0';
        const enemyHpText = document.getElementById('enemyHpText');
        const playerHpText = document.getElementById('playerHpText');
        const enemyHpBar = document.getElementById('enemyHpBar');
        const playerHpBar = document.getElementById('playerHpBar');
        if (enemyHpText) enemyHpText.textContent = '0/0';
        if (playerHpText) playerHpText.textContent = '0/0';
        if (enemyHpBar) enemyHpBar.style.width = '0%';
        if (playerHpBar) playerHpBar.style.width = '0%';
        if (enemyHandEl) enemyHandEl.innerHTML = '';
        if (playerHandEl) playerHandEl.innerHTML = '';
        if (duelLogEl) duelLogEl.innerHTML = 'Пошук ворога...';

        // Автоматично починаємо пошук/запуск дуелі
        setTimeout(() => this.startRandomDuel(), 250);
      },

      buildDuelDeckFromProfile(profile) {
        // Використовуємо level з progress для розрахунку сили в дуелі
        return profile.deckCards.map(dc => {
          const card = getCardById(dc.id);
          const prog = window.getProgress ? window.getProgress(profile, dc.id) : { level: 1, xp: 0 };
          const cardLevel = prog.level;
          const power = window.getPower ? window.getPower(card, cardLevel) : Math.round(card.basePower * Math.pow(card.upgradeMult, cardLevel - 1));
          return { id: card.id, element: card.element, power, level: cardLevel };
        });
      },

      calcDeckPower(deck) {
        return deck.reduce((s, c) => s + (c.power || 0), 0);
      },

      // Генерация адаптивной колоды противника: пытаемся приблизиться к суммарной силе игрока ±20
      generateAdaptiveEnemyDeck(playerDeck9, profile) {
        const calcPower = (card, level = 1) => {
          if (window.getPower) return window.getPower(card, level);
          return card.attack || card.basePower || 0;
        };

        // вычисляем суммарную силу игрока, опираясь на прогресс, если доступен
        let playerTotal = 0;
        try {
          if (profile && profile.deckCards && profile.deckCards.length) {
            profile.deckCards.forEach(dc => {
              const src = (window.ALL_CARDS || []).find(x => x.id === dc.id) || null;
              const prog = window.getProgress ? window.getProgress(profile, dc.id) : { level: dc.level || 1 };
              const lvl = (prog && prog.level) ? prog.level : (dc.level || 1);
              if (src) playerTotal += calcPower(src, lvl) || 0;
            });
          } else {
            playerTotal = playerDeck9.reduce((s, c) => s + (calcPower(c, 1) || 0), 0);
          }
        } catch (err) {
          playerTotal = playerDeck9.reduce((s, c) => s + (calcPower(c, 1) || 0), 0);
        }

        // Выбираем целевую суммарную силу врага в диапазоне [playerTotal - MAX_DIFF, playerTotal + MAX_DIFF]
        const MAX_DIFF = 20;
        const minTarget = Math.max(20, playerTotal - MAX_DIFF);
        const maxTarget = Math.max(minTarget, playerTotal + MAX_DIFF);
        const targetTotal = Math.floor(Math.random() * (maxTarget - minTarget + 1)) + minTarget;

        // pool: если мало карт - используем ALL_CARDS
        const allCards = window.ALL_CARDS || window.CARDS_COMMON || [];
        let pool = allCards.slice().filter(c => !(String(c.id).startsWith('S')));
        if (pool.length < 9) pool = allCards.slice();

        const cardPower = c => calcPower(c, 1) || 0;

        // Greedy selection
        const selected = [];
        let currentSum = 0;
        for (let slot = 0; slot < 9; slot++) {
          let bestIdx = -1;
          let bestDelta = Infinity;
          for (let i = 0; i < pool.length; i++) {
            const p = cardPower(pool[i]);
            const newSum = currentSum + p;
            const delta = Math.abs(newSum - targetTotal);
            if (delta < bestDelta) { bestDelta = delta; bestIdx = i; }
          }
          if (bestIdx === -1) break;
          const pick = pool.splice(bestIdx, 1)[0];
          selected.push(pick);
          currentSum += cardPower(pick);
        }

        // Fill if not enough
        if (selected.length < 9) {
          const extras = (allCards.concat(selected)).slice(0, 9 - selected.length);
          selected.push(...extras);
        }

        // Level-up selected cards to approach targetTotal
        const enriched = selected.map(c => ({ src: c, level: 1, power: cardPower(c) }));
        let selectedSum = enriched.reduce((s, e) => s + e.power, 0);
        let attempts = 0;
        const maxAttempts = 500;
        while (selectedSum < targetTotal && attempts < maxAttempts) {
          let bestIdx = -1;
          let bestGain = 0;
          for (let i = 0; i < enriched.length; i++) {
            const e = enriched[i];
            const nextLevel = Math.min((e.level || 1) + 1, 20);
            const nextPower = calcPower(e.src, nextLevel) || e.power;
            const gain = nextPower - e.power;
            if (gain > bestGain) { bestGain = gain; bestIdx = i; }
          }
          if (bestIdx === -1 || bestGain <= 0) break;
          enriched[bestIdx].level = Math.min((enriched[bestIdx].level || 1) + 1, 20);
          enriched[bestIdx].power = calcPower(enriched[bestIdx].src, enriched[bestIdx].level) || enriched[bestIdx].power;
          selectedSum = enriched.reduce((s, e) => s + e.power, 0);
          attempts++;
        }

        // Map to lightweight enemy objects compatible with legacy duel (include level)
        const enemyDeck9 = enriched.map(e => ({ id: e.src.id, element: e.src.element, power: Math.max(1, Math.round(e.power || 1)), level: e.level || 1 }));
        return enemyDeck9;
      },

      xpNeededForLevel(level) {
        // Exponential XP curve: increase base and growth for steeper requirements
        // New defaults: base 200, growth 1.25 (level 1 -> 200, level 5 -> ~610)
        const base = 200;
        const growth = 1.25;
        const lvl = Math.max(1, Math.floor(level || 1));
        return Math.floor(base * Math.pow(growth, lvl - 1));
      },

      pendingDuel: null,

      createCardNode(card, isPlayer, slotIdx) {
        // Try to reuse existing deck/card renderer so duel visuals match deck visuals
        try {
          // If duel passes lightweight objects (id + power), resolve full card data from DB
          const srcCard = (card && card.id && window.getCardById) ? window.getCardById(card.id) : null;
          const powerVal = card.power || card.attack || (srcCard ? (srcCard.basePower || srcCard.power) : 0) || 0;
          const renderSource = srcCard ? { ...srcCard, power: powerVal } : { ...card, power: powerVal };

          // If site has a deck renderer, prefer it (keeps consistent HTML)
          if (typeof this.renderDeckCard === 'function') {
            const html = this.renderDeckCard(renderSource, card.level || renderSource.level || 1);
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html.trim();
            const node = wrapper.firstElementChild || wrapper;
            node.classList.add('duel-card');
            if (slotIdx !== undefined) node.dataset.slot = slotIdx;
            return node;
          }

          if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
            const html = window.cardRenderer.render(renderSource, { level: card.level || renderSource.level || 1, power: powerVal });
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html.trim();
            const node = wrapper.firstElementChild || wrapper;
            node.classList.add('duel-card');
            if (slotIdx !== undefined) node.dataset.slot = slotIdx;
            return node;
          }

          if (window.createCardView) {
            const view = window.createCardView(renderSource);
            if (view && view.outerHTML) {
              view.classList.add('duel-card');
              if (slotIdx !== undefined) view.dataset.slot = slotIdx;
              return view;
            }
          }
        } catch (err) {
          console.warn('createCardNode: renderer fallback failed', err);
        }

        // Fallback minimal DOM if no renderer available
        const elementIcons = {
          fire: '<div class="element-emoji fire-emoji">🔥</div>',
          water: '<div class="element-emoji water-emoji">💧</div>',
          air: '<div class="element-emoji air-emoji">💨</div>',
          earth: '<div class="element-emoji earth-emoji">🍃</div>'
        };
        const elementIcon = elementIcons[card.element] || elementIcons.fire;
        const el = document.createElement('div');
        el.className = `sp-card ${card.element} common duel-card`;
        if (slotIdx !== undefined) el.dataset.slot = slotIdx;
        el.innerHTML = `
          <div class="corner-gear">
            ${elementIcon}
          </div>
          <div class="power-plate"><div class="power-value">${card.power}</div></div>
        `;
        return el;
      },

      startRandomDuel() {
        const profile = userProfile.getProfile();
        if (!profile || !profile.deckCards || profile.deckCards.length < 9) {
          alert('Колода неповна. Потрібно 9 карт.');
          return;
        }
        const playerDeck9 = this.buildDuelDeckFromProfile(profile);
        const playerPower = this.calcDeckPower(playerDeck9);

        // Генерируем адаптивную колоду противника с использованием новой логики (приближенно к playerPower ±100)
        const enemyDeck9 = this.generateAdaptiveEnemyDeck(playerDeck9, profile);
        let enemyPower = this.calcDeckPower(enemyDeck9);

        // Зберігаємо pending
        this.pendingDuel = { playerDeck9, enemyDeck9, playerPower, enemyPower };
        // Автоматичний пошук/початок бою — міні-таймаут для відчуття пошуку
        const logEl = document.getElementById('duelLog');
        if (logEl) logEl.textContent = 'Противник знайдений — готуємось...';
        setTimeout(() => {
          window.CURRENT_DUEL = window.createDuel(this.pendingDuel.playerDeck9, this.pendingDuel.enemyDeck9);
          this.renderDuel();
        }, 700);
      },

      showPreDuelDialog() {
        const modal = document.getElementById('duel-pre-modal');
        if (!modal || !this.pendingDuel) return;
        const profile = userProfile.getProfile();
        const enemyNameEl = document.getElementById('duel-pre-name');
        const enemyPowerEl = document.getElementById('duel-pre-power');
        const playerPowerEl = document.getElementById('duel-pre-player-power');

        // Генеруємо ім'я ворога
        const names = ['Lucky Harry','Steam Witch','Rust Baron','Copper Shade','Gearmancer','Brass Vex','Coal Phantom'];
        const picked = names[Math.floor(Math.random()*names.length)];
        this.pendingDuel.enemyName = picked;

        if (enemyNameEl) enemyNameEl.textContent = picked;
        if (enemyPowerEl) enemyPowerEl.textContent = this.pendingDuel.enemyPower;
        if (playerPowerEl) playerPowerEl.textContent = this.pendingDuel.playerPower;

        modal.classList.add('active');

        const attackBtn = document.getElementById('duel-pre-attack');
        const rerollBtn = document.getElementById('duel-pre-reroll');
        if (attackBtn) {
          attackBtn.onclick = () => {
            modal.classList.remove('active');
            window.CURRENT_DUEL = window.createDuel(this.pendingDuel.playerDeck9, this.pendingDuel.enemyDeck9);
            this.renderDuel();
          };
        }
        if (rerollBtn) {
          rerollBtn.onclick = () => {
            modal.classList.remove('active');
            this.startRandomDuel();
          };
        }
      },

      renderDuel() {
        const duel = window.CURRENT_DUEL;
        if (!duel) return;

        // Update legacy text nodes if present
        const legacyEnemyHp = document.getElementById('enemyHp');
        const legacyPlayerHp = document.getElementById('playerHp');
        if (legacyEnemyHp) legacyEnemyHp.textContent = `${duel.enemy.hp}/${duel.enemy.maxHp}`;
        if (legacyPlayerHp) legacyPlayerHp.textContent = `${duel.player.hp}/${duel.player.maxHp}`;

        // Update new HUD bars and labels
        const enemyHpText = document.getElementById('enemyHpText');
        const playerHpText = document.getElementById('playerHpText');
        const enemyHpBar = document.getElementById('enemyHpBar');
        const playerHpBar = document.getElementById('playerHpBar');
        if (enemyHpText) enemyHpText.textContent = `${duel.enemy.hp}/${duel.enemy.maxHp}`;
        if (playerHpText) playerHpText.textContent = `${duel.player.hp}/${duel.player.maxHp}`;
        if (enemyHpBar) {
          const pct = Math.max(0, Math.min(100, Math.round((duel.enemy.hp / Math.max(1, duel.enemy.maxHp)) * 100)));
          enemyHpBar.style.width = pct + '%';
        }
        if (playerHpBar) {
          const pctP = Math.max(0, Math.min(100, Math.round((duel.player.hp / Math.max(1, duel.player.maxHp)) * 100)));
          playerHpBar.style.width = pctP + '%';
        }

        const enemyPowerEl = document.getElementById('enemyPower');
        const playerPowerEl = document.getElementById('playerPower');
        if (enemyPowerEl) enemyPowerEl.textContent = duel.enemy.maxHp;
        if (playerPowerEl) playerPowerEl.textContent = duel.player.maxHp;

        // Prefer slot-based rendering if duelGrid slots exist (one column per slot)
        const enemySlot0 = document.getElementById('enemySlot0');
        const enemySlot1 = document.getElementById('enemySlot1');
        const enemySlot2 = document.getElementById('enemySlot2');
        const playerSlot0 = document.getElementById('playerSlot0');
        const playerSlot1 = document.getElementById('playerSlot1');
        const playerSlot2 = document.getElementById('playerSlot2');

        if (enemySlot0 && playerSlot0) {
          // Clear existing slots
          [enemySlot0, enemySlot1, enemySlot2, playerSlot0, playerSlot1, playerSlot2].forEach(el => { if(el) el.innerHTML = ''; });

          // Render enemy hand into slots
          duel.enemy.hand.forEach((c, idx) => {
            const node = this.createCardNode(c, false, idx);
            const slot = document.getElementById(`enemySlot${idx}`);
            if (slot) slot.appendChild(node);
          });

          // Render player hand into slots (click to play)
          duel.player.hand.forEach((c, idx) => {
            const node = this.createCardNode(c, true, idx);
            node.addEventListener('click', () => {
              if (duel.finished) return;
              window.CURRENT_DUEL = window.playTurn(duel, idx);
              this.renderDuel();
              if (window.CURRENT_DUEL.finished) this.showDuelResult(window.CURRENT_DUEL);
            });
            const slot = document.getElementById(`playerSlot${idx}`);
            if (slot) slot.appendChild(node);
          });
        } else {
          // Fallback to original behavior
          const enemyHandEl  = document.getElementById('enemyHand');
          const playerHandEl = document.getElementById('playerHand');
          if (enemyHandEl) enemyHandEl.innerHTML = '';
          if (playerHandEl) playerHandEl.innerHTML = '';

          duel.enemy.hand.forEach((c, idx) => {
            const node = this.createCardNode(c, false, idx);
            enemyHandEl && enemyHandEl.appendChild(node);
          });

          duel.player.hand.forEach((c, idx) => {
            const node = this.createCardNode(c, true, idx);
            node.addEventListener('click', () => {
              if (duel.finished) return;
              window.CURRENT_DUEL = window.playTurn(duel, idx);
              this.renderDuel();
              if (window.CURRENT_DUEL.finished) this.showDuelResult(window.CURRENT_DUEL);
            });
            playerHandEl && playerHandEl.appendChild(node);
          });
        }

        const logEl = document.getElementById('duelLog');
        logEl.innerHTML = duel.log.map(r => `Хід ${r.turn}: Ви(${r.player.element}) ${r.player.dmg} ×${r.player.mult} ↔ Ворог(${r.enemy.element}) ${r.enemy.dmg} ×${r.enemy.mult}`).join('<br>');
        
        this.updatePlayerMultiplierPreview();
      },

      showDuelResult(duel) {
        const profile = userProfile.getProfile();
        if (!profile) return;

        const modal = document.getElementById('duel-result-modal');
        const titleEl = document.getElementById('duel-result-title');
        const subtitleEl = document.getElementById('duel-result-subtitle');
        const rewardsEl = document.getElementById('duel-result-rewards');
        const winsInfoEl = document.getElementById('duel-wins-info');
        const summaryHpEl = document.getElementById('duel-summary-player-hp');
        const battleCardsEl = document.getElementById('duel-battle-cards');

        if (!modal) return;

        // Визначити результат за HP (якщо HP гравця 0 - поразка, якщо ворога 0 - перемога)
        let result = duel.result;
        if (duel.player.hp === 0 && duel.enemy.hp > 0) {
          result = 'lose';
        } else if (duel.enemy.hp === 0 && duel.player.hp > 0) {
          result = 'win';
        }

        let xpGain = 0;
        let boltsGain = 0;
        let dropInfo = '';

        if (result === 'win') {
          titleEl.textContent = '🏆 ПЕРЕМОГА';
          xpGain = Math.round(80 * Math.pow(1.08, (profile.level||1)-1));
          boltsGain = Math.round(55 * Math.pow(1.12, (profile.level||1)-1));
          profile.wins = (profile.wins || 0) + 1;
          // Система дропа карт з урахуванням рідкості
          if (window.dropSystem && window.dropSystem.shouldDrop('win')) {
            // Ініціалізація pity лічильників
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              
              // Оновити pity лічильники
              profile.pityCounters = dropResult.pityCounters;
              
              // Додати карту в колекцію
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              // Оновити інвентар
              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              // Показати інформацію про дроп
              const rarityNames = { R1: 'звичайна', R2: 'незвичайна', R3: 'рідкісна', R4: 'епічна', R5: 'легендарна', R6: 'міфічна' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (стартова)' : '';
              dropInfo = ` + ${rarityName} карта ${card.id}${sourceInfo}`;
            }
          }
        } else if (result === 'lose') {
          titleEl.textContent = '💀 ПОРАЗКА';
          xpGain = Math.round(30 * Math.pow(1.05, (profile.level||1)-1));
          boltsGain = Math.round(12 * Math.pow(1.08, (profile.level||1)-1));
          profile.losses = (profile.losses || 0) + 1;
          
          // Менший шанс дропа при поразці (10%)
          if (window.dropSystem && window.dropSystem.shouldDrop('lose')) {
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              profile.pityCounters = dropResult.pityCounters;
              
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              const rarityNames = { R1: 'звичайна', R2: 'незвичайна', R3: 'рідкісна', R4: 'епічна', R5: 'легендарна', R6: 'міфічна' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (стартова)' : '';
              dropInfo = ` + ${rarityName} карта ${card.id}${sourceInfo}`;
            }
          }
        } else {
          titleEl.textContent = '⚖️ НІЧИЯ';
          xpGain = Math.round(45 * Math.pow(1.06, (profile.level||1)-1));
          boltsGain = Math.round(28 * Math.pow(1.1, (profile.level||1)-1));
          
          // Середній шанс дропа при нічиї (20%)
          if (window.dropSystem && window.dropSystem.shouldDrop('draw')) {
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              profile.pityCounters = dropResult.pityCounters;
              
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              const rarityNames = { R1: 'звичайна', R2: 'незвичайна', R3: 'рідкісна', R4: 'епічна', R5: 'легендарна', R6: 'міфічна' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (стартова)' : '';
              dropInfo = ` + ${rarityName} карта ${card.id}${sourceInfo}`;
            }
          }
        }

        subtitleEl.textContent = 'Ви отримали:';

        // Оновити профіль
        profile.xp = (profile.xp || 0) + xpGain;
        profile.bolts = (profile.bolts || 0) + boltsGain;
        profile.gamesPlayed = (profile.gamesPlayed || 0) + 1;

        // Перевірити рівень (шестерні нараховуються лише при підвищенні рівня)
        let leveled = 0;
        let gearsGained = 0;
        while (profile.xp >= this.xpNeededForLevel(profile.level || 1)) {
          const need = this.xpNeededForLevel(profile.level || 1);
          profile.xp -= need;
          // Збільшуємо рівень
          profile.level = (profile.level || 1) + 1;
          // Нараховуємо шестерні за цей рівень (логіка: додаємо кількість шестерень рівня)
          const gearForThisLevel = profile.level;
          profile.gears = (profile.gears || 0) + gearForThisLevel;
          gearsGained += gearForThisLevel;
          leveled += 1;
        }

        userProfile.updateCurrentUser(profile);
        userProfile.updateUI();

        // Показати лише те, що отримано у бою: XP, болти, дроп, та шестерні (якщо були отримані через рівень)
        const parts = [];
        if (xpGain > 0) parts.push(`XP: +${xpGain}`);
        if (boltsGain > 0) parts.push(`🔩 +${boltsGain}`);
        if (gearsGained > 0) parts.push(`⚙️ +${gearsGained}`);
        if (dropInfo) parts.push(dropInfo.trim());
        rewardsEl.textContent = parts.join('  •  ') || 'Нічого не отримано';
        winsInfoEl.textContent = `Побід в дуелях: 🏆 ${profile.wins || 0}`;
        summaryHpEl.textContent = duel.player.hp;

        // Показати підсумки бою з картами
        const elementEmojis = {
          fire: '🔥',
          water: '💧',
          air: '💨',
          earth: '🍃'
        };

        battleCardsEl.innerHTML = duel.log.map(log => {
          const pEmoji = elementEmojis[log.player.element] || elementEmojis.fire;
          const eEmoji = elementEmojis[log.enemy.element] || elementEmojis.fire;
          return `
            <div class="duel-battle-card-row">
              <div class="duel-battle-card-player">
                <div class="duel-battle-card-icon" style="--elem: var(--${log.player.element})">
                  <span class="element-emoji">${pEmoji}</span>
                </div>
                <span class="duel-battle-card-dmg">${log.player.dmg}</span>
              </div>
              <span class="duel-battle-vs">⚔</span>
              <div class="duel-battle-card-enemy">
                <span class="duel-battle-card-dmg">${log.enemy.dmg}</span>
                <div class="duel-battle-card-icon" style="--elem: var(--${log.enemy.element})">
                  <span class="element-emoji">${eEmoji}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');

        modal.classList.add('active');
      },

      closeDuelResult() {
        const modal = document.getElementById('duel-result-modal');
        if (modal) {
          modal.classList.remove('active');
          // Перезапустити дуель
          this.startRandomDuel();
        }
      }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Меню "Сумка"
      document.getElementById('menu-bag-btn')?.addEventListener('click', () => navigation.showPage('bag'));
      document.getElementById('bag-back-btn')?.addEventListener('click', () => navigation.showPage('home'));
      // Initialize auth UI
      authUI.init();
      
      // Update UI with profile data if logged in
      if (userProfile.isLoggedIn()) {
        userProfile.updateUI();
        console.log('User profile loaded:', userProfile.getCurrentUser());
      }
      
      // Navigation handlers for tiles
      document.querySelectorAll('[data-page]').forEach(element => {
        element.addEventListener('click', (e) => {
          e.preventDefault();
          const pageId = element.dataset.page;
          navigation.showPage(pageId);
        });
      });
      
      // Bottom nav handlers
      const navButtons = {
        'nav-home': 'home',
        'nav-profile': 'profile',
        'nav-guild': 'guild'
      };
      
      document.querySelectorAll('.navbtn').forEach(btn => {
        btn.addEventListener('click', () => {
          // Update active state
          document.querySelectorAll('.navbtn').forEach(x => x.classList.remove('active'));
          btn.classList.add('active');
          
          // Navigate to page
          const pageId = navButtons[btn.id];
          if (pageId) {
            navigation.showPage(pageId);
          }
        });
      });
      
      // Logout button handler
      document.querySelector('.logout-btn')?.addEventListener('click', () => {
        if (confirm('Ви впевнені, що хочете вийти?')) {
          userProfile.logout();
          location.reload();
        }
      });
      
      // Shop tab handlers
      document.querySelectorAll('.shop-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Update active tab
          document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show corresponding content
          const tabId = this.dataset.tab;
          document.querySelectorAll('.shop-tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`shop-tab-${tabId}`)?.classList.add('active');
        });
      });

      // Card filter handlers
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Update active state
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Load filtered cards
          const element = this.dataset.element;
          navigation.currentCardFilter = element;
          navigation.loadShopCards(element);
        });
      });

      // Pack modal close handler
      document.getElementById('pack-modal-close')?.addEventListener('click', () => {
        navigation.closePackModal();
      });

      // Click outside modal to close
      document.getElementById('pack-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'pack-modal') {
          navigation.closePackModal();
        }
      });

      // Duel result modal close handler
      document.getElementById('duel-result-close')?.addEventListener('click', () => {
        navigation.closeDuelResult();
      });

      // Click outside duel modal to close
      document.getElementById('duel-result-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'duel-result-modal') {
          navigation.closeDuelResult();
        }
      });
    });

    // Accordion (removed since we're using page navigation now)

    // Tiles (removed since we're using page navigation now)

  </script>
  <!-- orientation script removed -->
</body>
</html>
